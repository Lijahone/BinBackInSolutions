
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions ‚Äî Synced</title>
<style>
  :root{ --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; --brand:#2563eb; }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
    padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:10;flex-wrap:wrap}
  .brand{font-weight:800;font-size:18px}
  .spacer{flex:1}
  .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer;font-weight:600}
  .btn.small{padding:8px 10px;font-size:14px}
  .seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
  .seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
  .seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
  main{max-width:980px;margin:0 auto;padding:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
    background:var(--card);padding:8px 12px;border-radius:12px;min-width:180px}
  .search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
  .card{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:14px 12px}
  .list{display:grid;gap:10px}
  .area-row{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--border);border-radius:14px;background:var(--card);padding:12px 12px}
  .area-name{font-weight:800}
  .week-picker{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .week-pill{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:var(--card)}
  .addr{display:grid;gap:10px;border:1px solid var(--border);border-radius:16px;padding:14px 12px;margin-bottom:10px;background:var(--card);position:relative}
  .topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .name{font-weight:800}
  .meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
  .actions{display:flex;gap:12px 14px;align-items:flex-start;flex-wrap:wrap}
  .actions > *{flex:0 0 auto;}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .icon-btn{border:1px solid var(--border);background:var(--card);font-size:18px;line-height:1;min-width:30px;min-height:28px;
    padding:2px 8px;border-radius:10px;color:var(--muted);cursor:pointer;touch-action:manipulation}
  .icon-btn:active{transform:scale(0.98)}
  .maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
  .note{width:100%;font-size:16px;line-height:1.35;padding:6px 10px;border:1px solid var(--border);border-radius:10px;resize:none;overflow:hidden;height:30px;min-height:30px;max-height:78px;background:transparent}
  .note::placeholder{color:var(--muted);opacity:.75}
  .toggleWrap{display:flex;flex-direction:column;align-items:flex-start;gap:6px;min-height:72px}
  .statusline{height:22px;line-height:22px;font-size:13px;color:var(--muted)}
  .statusline .label{font-weight:700;color:var(--ink)}
  .statusline .who{font-weight:700}
  .statusline .time{opacity:.9}
  .banner{display:flex;gap:8px;align-items:center;border:1px dashed var(--border);background:#fff5; padding:8px 12px;border-radius:10px;font-size:12px}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:420px;width:92%}
  .modal h3{margin:0 0 8px 0}
  .field{display:flex;gap:8px;margin:10px 0}
  .field input{flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:transparent;color:var(--ink)}
</style>
</head>
<body>
<header>
  <button id="backBtn" class="btn small" type="button" style="display:none">‚Üê Back</button>
  <div class="brand">Bin Back In Solutions</div>
  <div class="spacer"></div>
  <button id="addAreaBtn" class="btn" type="button" title="Add area">+ Area</button>
  <button id="userBtn" class="btn" type="button">User</button>
</header>

<main id="main"></main>

<!-- Name Modal -->
<div class="modal-backdrop" id="nameModal" aria-modal="true" role="dialog">
  <div class="modal">
    <h3>Who‚Äôs using the app?</h3>
    <p style="margin:0 0 8px;color:var(--muted)">Enter the name that should appear on updates (e.g., ‚ÄúLija‚Äù, ‚ÄúSam‚Äù).</p>
    <div class="field">
      <input id="nameInput" placeholder="Your name" maxlength="30" />
      <button id="saveName" class="btn" type="button">Save</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, collectionGroup, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAaDT6hFD38_P1AhQMF_vT18tXG9_pp8Sw",
  authDomain: "binbackinsolutions.firebaseapp.com",
  projectId: "binbackinsolutions",
  storageBucket: "binbackinsolutions.firebasestorage.app",
  messagingSenderId: "740345071529",
  appId: "1:740345071529:web:e960f05ba0c982194126b8",
  measurementId: "G-6XK5H9LWWK"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Predefined addresses for the Luxuryaway area
const LUXURYAWAY_ADDRESSES = [
  "5A Vanda Place, Fernhill",
  "5B Vanda Place, Fernhill",
  "3 Caples Place, Fernhill",
  "5/55 Kent Street, Queenstown",
  "2/27 Panorama Terrace, Queenstown",
  "2 Peregrine Place, Queenstown",
  "16 Plough Street, Jacks Point",
  "73 McDonnell Road, Arrowtown",
  "104 Cotter Avenue, Arrowtown",
  "56 Middleton Road, Queenstown",
  "41 Middleton Road, Queenstown",
  "969 Frankton Road, Queenstown"
];


// Util
const $=s=>document.querySelector(s);
const main=$("#main");
const LS_USER='bbi_user_name';
function currentName(){ return localStorage.getItem(LS_USER) || ""; }
function setCurrentName(name){ localStorage.setItem(LS_USER, name); }
const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
function mondayOf(date){ const d=new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; } // Monday start
function weekKeyOf(date){ const m=mondayOf(date); const y=m.getFullYear(); const oneJan=new Date(y,0,1); const diff=Math.floor((m - mondayOf(oneJan)) / (7*24*3600*1000))+1; const ww=String(diff).padStart(2,'0'); return `${y}-W${ww}`; }
function weekRange(key){ const [y,w]=key.split('-W'); const year=parseInt(y,10); const week=parseInt(w,10); const jan1=new Date(year,0,1); const mon=mondayOf(jan1); mon.setDate(mon.getDate()+(week-1)*7); const days=[0,1,2,3,4].map(i=>{ const d=new Date(mon); d.setDate(mon.getDate()+i); return d; }); return days; }
function fmtDate(d){ return d.toLocaleDateString([], {weekday:'short', day:'2-digit', month:'short'}); }
function fmtShort(ts){ if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})+' ¬∑ '+d.toLocaleDateString([], {weekday:'short'})+' '+d.toLocaleDateString([], {day:'2-digit',month:'short'}); }

// App state
const STATE = {
  view: 'areas', // 'areas' | 'weeks' | 'run'
  areaId: null,
  areaName: null,
  weekKey: null,
  dayFilter: 'All',
  search: ''
};

// Name modal
const nameModal=$("#nameModal");
const nameInput=$("#nameInput");
function openNameModal(){ nameInput.value=currentName(); nameModal.style.display='flex'; setTimeout(()=>nameInput.focus(),50); }
function closeNameModal(){ nameModal.style.display='none'; }
async function saveName(){
  const v=(nameInput.value||'').trim();
  if(v.length<2){ alert('Please enter at least 2 characters.'); return; }
  setCurrentName(v);
  try{
    const uid=(auth.currentUser && auth.currentUser.uid) || 'anon';
    await setDoc(doc(db,'profiles',uid), { displayName:v, updatedAt: Date.now() }, { merge:true });
  }catch(e){}
  closeNameModal();
}
$("#userBtn").addEventListener('click', (e)=>{ e.preventDefault(); openNameModal(); }, {passive:false});
$("#saveName").addEventListener('click', saveName);
nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveName(); } });
nameModal.addEventListener('click', (e)=>{ if(e.target===nameModal){ closeNameModal(); } }, {passive:true});

// Start & ensure default area
async function start(){
  await signInAnonymously(auth);
  if(!(currentName().trim().length>=2)) openNameModal();
  // Ensure default "Queenstown"
  const qId='queenstown';
  const qDoc=doc(db,'areas',qId);
  const snap=await getDoc(qDoc);
  if(!snap.exists()){ await setDoc(qDoc, { name:'Queenstown', createdAt: Date.now() }); }
  // Ensure default "Luxuryaway"
  const lId='luxuryaway';
  const lDoc=doc(db,'areas',lId);
  const lSnap=await getDoc(lDoc);
  if(!lSnap.exists()){ await setDoc(lDoc, { name:'Luxuryaway', createdAt: Date.now() }); }

  renderAreas();
}
start();

// AREAS VIEW
async function renderAreas(){
  STATE.view='areas'; STATE.areaId=null; STATE.areaName=null;
  $("#backBtn").style.display='none';
  const areasSnap = await getDocs(collection(db,'areas'));
  const items = areasSnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> a.name.localeCompare(b.name));
  main.innerHTML = `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <h2 style="margin:6px 0">Areas</h2>
        <div class="banner" id="status">Choose an area (or add a new one).</div>
      </div>
      <div class="list" id="areaList"></div>
    </div>`;
  const list=$("#areaList");
  for(const it of items){
    const row=document.createElement('div'); row.className='area-row';
    row.innerHTML=`<div class="area-name">${it.name}</div><button class="btn small" data-act="open-area" data-id="${it.id}" data-name="${it.name}">Open</button>`;
    list.appendChild(row);
  }
  list.addEventListener('click', (e)=>{
    const b=e.target.closest('[data-act="open-area"]'); if(!b) return;
    openWeeks(b.getAttribute('data-id'), b.getAttribute('data-name'));
  }, {passive:true});

  $("#addAreaBtn").onclick = async ()=>{
    const name=prompt('New area name (e.g., Queenstown):'); if(!name||!name.trim()) return;
    const id=slug(name);
    await setDoc(doc(db,'areas',id), { name: name.trim(), createdAt: Date.now() });
    renderAreas();
  };
}

// WEEKS VIEW
function weekNavHTML(key){
  const days=weekRange(key);
  const label = `${key} ¬∑ ${fmtDate(days[0])} ‚Üí ${fmtDate(days[4])}`;
  return `<div class="week-picker">
    <button class="btn small" id="prevWeek">‚óÄ</button>
    <span class="week-pill">${label}</span>
    <button class="btn small" id="nextWeek">‚ñ∂</button>
    <button class="btn" id="openWeek">Open Week</button>
  </div>`;
}
function prevWeek(key){ const [y,w]=key.split('-W'); const year=parseInt(y,10); const wk=parseInt(w,10); const d=weekRange(key)[0]; d.setDate(d.getDate()-7); return weekKeyOf(d); }
function nextWeek(key){ const d=weekRange(key)[0]; d.setDate(d.getDate()+7); return weekKeyOf(d); }

function openWeeks(areaId, areaName){
  STATE.view='weeks'; STATE.areaId=areaId; STATE.areaName=areaName; STATE.weekKey=weekKeyOf(new Date());
  $("#backBtn").style.display='inline-block';
  $("#backBtn").onclick = renderAreas;

  main.innerHTML = `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <h2 style="margin:6px 0">${areaName}</h2>
        <div class="banner">Select a calendar week (Mon‚ÄìFri).</div>
      </div>
      <div id="weekNav">${weekNavHTML(STATE.weekKey)}</div>
    </div>`;

  $("#prevWeek").onclick=()=>{ STATE.weekKey=prevWeek(STATE.weekKey); $("#weekNav").innerHTML=weekNavHTML(STATE.weekKey); attachWeekNav(); };
  $("#nextWeek").onclick=()=>{ STATE.weekKey=nextWeek(STATE.weekKey); $("#weekNav").innerHTML=weekNavHTML(STATE.weekKey); attachWeekNav(); };
  $("#openWeek").onclick=()=> openRun();

  function attachWeekNav(){
    $("#prevWeek").onclick=()=>{ STATE.weekKey=prevWeek(STATE.weekKey); $("#weekNav").innerHTML=weekNavHTML(STATE.weekKey); attachWeekNav(); };
    $("#nextWeek").onclick=()=>{ STATE.weekKey=nextWeek(STATE.weekKey); $("#weekNav").innerHTML=weekNavHTML(STATE.weekKey); attachWeekNav(); };
    $("#openWeek").onclick=()=> openRun();
  }
}

// RUN VIEW (the working app), scoped to area+week
let RUN = {
  unsub: null,
  addrRef: null,
  ADDRS: [],
  filterDay: 'All',
  filterText: ''
};

function daySegHTML(){
  return `<div class="seg" id="daySeg">
    <button data-day="All" class="active">All</button>
    <button data-day="Monday">Mon</button>
    <button data-day="Tuesday">Tue</button>
    <button data-day="Wednesday">Wed</button>
    <button data-day="Thursday">Thu</button>
    <button data-day="Friday">Fri</button>
  </div>`;
}

function runToolbarHTML(){
  return `<div class="toolbar">
    <div class="search">
      <span>üîé</span><input id="search" placeholder="Search address‚Ä¶" />
    </div>
    <button id="refresh" class="btn" type="button">Refresh</button>
    <button id="optimiseOut" class="btn" type="button">Optimise Out</button>
    <button id="optimiseBack" class="btn" type="button">Optimise Back</button>
    <button id="addBtn" class="btn" type="button">+ Address</button>
  </div>`;
}

function setBanner(t){ const b=document.getElementById('status'); if(b) b.textContent=t; }

async function openRun(){
  STATE.view='run'; RUN.filterDay='All'; RUN.filterText=''; $("#backBtn").style.display='inline-block';
  $("#backBtn").onclick = ()=> openWeeks(STATE.areaId, STATE.areaName);

  main.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h2 style="margin:6px 0">${STATE.areaName} ‚Äî ${STATE.weekKey}</h2>
      <div class="banner" id="status">Booting‚Ä¶</div>
    </div>
    ${daySegHTML()}
    ${runToolbarHTML()}
    <div id="list"></div>
  `;

  const addrCol = collection(db,'areas',STATE.areaId,'weeks',STATE.weekKey,'addresses');
  RUN.addrRef = addrCol;

  // Seed week from legacy root if empty
  const snap = await getDocs(addrCol);
  if(snap.empty){
    if(STATE.areaId==='luxuryaway'){
      // Seed from the predefined Luxuryaway list
      for(const addr of LUXURYAWAY_ADDRESSES){
        const id = slug(addr);
        const obj={
          address: addr,
          pickup: 'Tuesday',
          gas: 'No',
          out:false,outBy:'',outAt:0,
          back:false,backBy:'',backAt:0,
          note:'',updatedAt:Date.now(),rank: 999999
        };
        await setDoc(doc(addrCol, id), obj);
      }
    } else {
      const legacy = await getDocs(query(collection(db,'addresses'), orderBy('address')));
      const batch = [];
      legacy.forEach(d=>{
        const v=d.data();
        const obj={
          address: v.address || '',
          pickup: v.pickup || 'Tuesday',
          gas: v.gas || 'No',
          out:false,outBy:'',outAt:0,
          back:false,backBy:'',backAt:0,
          note:'',updatedAt:Date.now(),rank: (typeof v.rank==='number'?v.rank:999999)
        };
        batch.push({id:d.id, data:obj});
      });
      for(const it of batch){
        await setDoc(doc(addrCol, it.id), it.data);
      }
    }
  }

  // Live subscribe
  if(RUN.unsub) RUN.unsub();
  RUN.unsub = onSnapshot(query(addrCol, orderBy('address')), (s)=>{
    RUN.ADDRS = s.docs.map(d=>({ id:d.id, ...d.data() }));
    renderRun();
    setBanner("Live ‚Äî synced");
  });

  attachRunHandlers();
  setBanner("Connecting‚Ä¶");
}

function renderRun(){
  const listEl=$("#list"); listEl.innerHTML='';
  let rows = RUN.ADDRS.slice().sort((a,b)=>{
    const ra = (typeof a.rank==='number') ? a.rank : 1e9;
    const rb = (typeof b.rank==='number') ? b.rank : 1e9;
    if(ra!==rb) return ra - rb;
    return (a.address||'').localeCompare(b.address||'');
  });

  rows = rows.filter(it=> (RUN.filterDay==='All'||it.pickup===RUN.filterDay) && (!RUN.filterText|| (it.address||'').toLowerCase().includes(RUN.filterText)) );

  for(const it of rows){
    const outL = (it.outBy && it.outAt) ? `<span class="label">Out</span> ‚Äî <span class="who">${it.outBy}</span> ‚Äî <span class="time">${fmtShort(it.outAt)}</span>` : '&nbsp;';
    const backL = (it.backBy && it.backAt) ? `<span class="label">Back</span> ‚Äî <span class="who">${it.backBy}</span> ‚Äî <span class="time">${fmtShort(it.backAt)}</span>` : '&nbsp;';

    const row=document.createElement('div'); row.className='addr'; row.dataset.id=it.id;
    row.innerHTML=`
      <div class="topline">
        <div class="name">${it.address||''}</div>
        <div class="meta">
          <span class="badge">üóì ${it.pickup||''}</span>
          <button class="icon-btn del" type="button" data-act="delete" data-id="${it.id}" aria-label="Delete address" title="Delete">‚àí</button>
        </div>
      </div>
      <div class="actions">
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
          <div class="statusline" id="stat-out-${it.id}">${outL}</div>
        </div>
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
          <div class="statusline" id="stat-back-${it.id}">${backL}</div>
        </div>
        <a class="maplink" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((it.address||'')+', '+STATE.areaName)}" target="_blank" rel="noopener">Address map</a>
      </div>
      <textarea class="note" data-id="${it.id}" maxlength="120" placeholder="Notes"
        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false" inputmode="text">${it.note?String(it.note):""}</textarea>
    `;
    listEl.appendChild(row);
  }
  // Resize notes
  document.querySelectorAll('textarea.note').forEach(el=>{ el.style.height='auto'; const h=Math.min(el.scrollHeight,78); el.style.height=Math.max(30,h)+'px'; });
}

function attachRunHandlers(){
  // Day seg
  document.getElementById('daySeg').addEventListener('click', (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    document.querySelectorAll('#daySeg button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); RUN.filterDay=b.getAttribute('data-day'); renderRun();
  }, {passive:true});

  // Search
  document.getElementById('search').addEventListener('input', e=>{ RUN.filterText=e.target.value.toLowerCase(); renderRun(); });
  document.getElementById('refresh').addEventListener('click', ()=> location.reload());

  // Add Address
  document.getElementById('addBtn').addEventListener('click', async ()=>{
    const addr=prompt('New address (full street):'); if(!addr||!addr.trim()) return;
    const pickup=(prompt('Pickup day (Mon/Tue/Wed/Thu/Fri):','Tuesday')||'Tuesday').trim();
    const gasAns=(prompt('Gas replacement required? (yes/no):','no')||'no').trim().toLowerCase();
    const gas = (gasAns==='yes'||gasAns==='y') ? 'Yes' : 'No';
    const id=slug(addr);
    const obj={address:addr.trim(),pickup,gas,
      out:false,outBy:'',outAt:0,
      back:false,backBy:'',backAt:0,
      note:'', updatedAt:Date.now(), rank: 999999
    };
    try{ await setDoc(doc(RUN.addrRef, id), obj); } catch(err){ alert('Add failed: '+(err&&err.message?err.message:err)); }
  });

  // Toggles
  document.getElementById('list').addEventListener('change', async (e)=>{
    const cb=e.target.closest('input[type=checkbox]'); if(!cb) return;
    const id=cb.getAttribute('data-id'), act=cb.getAttribute('data-act');
    const t=Date.now(), who=currentName() || ("User-" + (auth.currentUser?.uid?.slice(-4)||'0000'));
    const patch={ updatedAt:t };
    if(act==='out'){ patch.out=cb.checked; patch.outBy=cb.checked?who:""; patch.outAt=cb.checked?t:0; }
    if(act==='back'){ patch.back=cb.checked; patch.backBy=cb.checked?who:""; patch.backAt=cb.checked?t:0; }
    try{ await updateDoc(doc(RUN.addrRef, id), patch); }catch(err){ alert('Update failed'); }
  });

  // Notes (debounced)
  const SAVE_T=new Map(); let EDITING_NOTE_ID=null; let EDITING_IDLE_T=null;
  document.getElementById('list').addEventListener('input', (e)=>{
    const ta=e.target.closest('textarea.note'); if(!ta) return;
    const id=ta.getAttribute('data-id'); const v=ta.value.slice(0,120);
    EDITING_NOTE_ID=id;
    ta.style.height='auto'; ta.style.height=Math.max(30, Math.min(ta.scrollHeight,78))+'px';
    if(SAVE_T.has(id)) clearTimeout(SAVE_T.get(id));
    SAVE_T.set(id, setTimeout(async ()=>{
      try{ await updateDoc(doc(RUN.addrRef, id), { note:v, updatedAt:Date.now() }); }catch(e){}
      SAVE_T.delete(id);
    }, 800));
    clearTimeout(EDITING_IDLE_T);
    EDITING_IDLE_T=setTimeout(()=>{ EDITING_NOTE_ID=null; }, 900);
  }, true);
  document.getElementById('list').addEventListener('blur', (e)=>{
    const ta=e.target.closest('textarea.note'); if(!ta) return;
    const id=ta.getAttribute('data-id'); const v=ta.value.slice(0,120);
    (async ()=>{ try{ await updateDoc(doc(RUN.addrRef, id), { note:v, updatedAt:Date.now() }); }catch(e){} })();
  }, true);

  // Delete (click+PIN)
  let DELETE_LOCK=false;
  document.getElementById('list').addEventListener('click', (e)=>{
    const del=e.target.closest('[data-act="delete"]'); if(!del) return;
    e.preventDefault();
    if(DELETE_LOCK) return;
    DELETE_LOCK=true;
    (async ()=>{
      try{
        if(!confirm('Remove this address (this week only)?')) return;
        const code = prompt('Enter passcode to confirm delete:');
        if(code!=='5952'){ alert('Incorrect passcode'); return; }
        await deleteDoc(doc(RUN.addrRef, del.getAttribute('data-id')));
      }catch(err){ alert('Delete failed'); }
      finally{ setTimeout(()=>DELETE_LOCK=false, 300); }
    })();
  }, {passive:false});

  // Optimise (iOS-safe)
  function toMapsAddresses(arr){ return arr.map(n => `${n.address}, ${STATE.areaName}`); }
  function buildOptimisedUrl(addresses, originStr){
    const dest = encodeURIComponent(addresses[0]);
    const rest = addresses.slice(1,24).map(p=>encodeURIComponent(p)).join('|');
    const wps = rest ? `optimize:true|${rest}` : 'optimize:true';
    return `https://www.google.com/maps/dir/?api=1${originStr?`&origin=${encodeURIComponent(originStr)}`:''}&destination=${dest}&waypoints=${wps}`;
  }
  function plan(kind){
    const visible = RUN.ADDRS.filter(it=> (RUN.filterDay==='All'||it.pickup===RUN.filterDay) && (!RUN.filterText|| (it.address||'').toLowerCase().includes(RUN.filterText)) );
    const need = visible.filter(a => kind==='out' ? !a.out : !a.back );
    const count = need.length;
    if(!count){ alert('No stops to visit for this view.'); return; }
    const parts = toMapsAddresses(need);
    const status=document.getElementById('status'); if(status) status.textContent=`Building route for ${count} stop${count>1?'s':''}‚Ä¶`;
    let tab=null; try{ tab = window.open('', '_blank'); }catch{ tab = null; }
    const navTo = (url)=>{
      if(tab && !tab.closed){ try{ tab.location = url; }catch{ window.location = url; } }
      else { window.location = url; }
      if(status) status.textContent=`Opened route with ${count} stop${count>1?'s':''}.`;
    };
    const fallback = ()=> navTo(buildOptimisedUrl(parts, ''));
    if(navigator.geolocation){
      let done=false;
      navigator.geolocation.getCurrentPosition(
        pos=>{ if(done) return; done=true; navTo(buildOptimisedUrl(parts, `${pos.coords.latitude},${pos.coords.longitude}`)); },
        _err=>{ if(done) return; done=true; fallback(); },
        { enableHighAccuracy:false, timeout:4000, maximumAge:60000 }
      );
      setTimeout(()=>{ if(!done){ done=true; fallback(); } }, 5000);
    }else{
      fallback();
    }
  }
  $("#optimiseOut").addEventListener('click', ()=> plan('out'), {passive:true});
  $("#optimiseBack").addEventListener('click', ()=> plan('back'), {passive:true});
}
</script>
</body>
</html>
