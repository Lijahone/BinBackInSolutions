<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions</title>
<style>
:root{
  --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; --brand:#2563eb;
  --logo:url('Bin_Back_In_Logo.png');
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;min-height:100%}
body::before{
  content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
  background-image: var(--logo);
  background-repeat:no-repeat; background-position:center; background-size:min(90vmin, 680px);
  opacity:.6; filter:grayscale(0.1);
}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
  padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:5;flex-wrap:wrap}
.brand{font-weight:800;font-size:18px}
.spacer{flex:1}
.btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer;font-weight:600}
.btn.primary{background:var(--brand);color:#fff;border-color:transparent}
.seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
.seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
.seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
main{max-width:980px;margin:0 auto;padding:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
  background:var(--card);padding:8px 12px;border-radius:12px;min-width:180px}
.search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
.addr{display:grid;gap:10px;border:1px solid var(--border);border-radius:16px;padding:14px 12px;margin-bottom:10px;background:var(--card);position:relative}
.topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.name{font-weight:800}
.meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
.actions{display:flex;gap:12px 14px;align-items:flex-start;flex-wrap:wrap}
.toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
.icon-btn{border:1px solid var(--border);background:var(--card);font-size:18px;line-height:1;min-width:30px;min-height:28px;
  padding:2px 8px;border-radius:10px;color:var(--muted);cursor:pointer;touch-action:manipulation}
.icon-btn:active{transform:scale(0.98)}
.maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
.note{width:100%;font-size:16px;line-height:1.35;padding:6px 10px;border:1px solid var(--border);border-radius:10px;resize:none;overflow:hidden;height:30px;min-height:30px;max-height:78px;background:transparent}
.note::placeholder{color:var(--muted);opacity:.75}
.toggleWrap{display:flex;flex-direction:column;align-items:flex-start;gap:6px;min-height:72px}
.statusline{height:22px;line-height:22px;font-size:13px;color:var(--muted)}
.statusline .label{font-weight:700;color:var(--ink)}
.statusline .who{font-weight:700}
.statusline .time{opacity:.9}
.banner{display:flex;gap:8px;align-items:center;border:1px dashed var(--border);background:#fff7; padding:8px 12px;border-radius:10px;font-size:12px}
select.areaSel{border:1px solid var(--border);background:var(--card);border-radius:10px;padding:8px 10px}

/* Gate layout: top/bottom halves */
body.gated main, body.gated header .app-only{display:none !important}
body.gated #gate{display:block}
#gate{position:fixed;inset:0;padding:16px;display:grid;grid-template-rows:1fr 1fr;gap:16px}
.gcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;display:flex;flex-direction:column}
.gtitle{font-size:20px;font-weight:900;margin:0 0 6px}
.muted{color:var(--muted)}
.field{display:flex;gap:8px;margin:8px 0;align-items:center}
.field input{flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--ink)}

/* Photo injector styles */
.bbi-photo-wrap{margin-top:8px}
.bbi-thumb{display:none;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#0001;cursor:pointer}
.bbi-thumb img{display:block;height:auto;max-height:340px;width:100%;object-fit:contain}
.bbi-photo-cap{margin-top:6px;color:#6b7280;font-size:12px}
.bbi-photo-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
.bbi-photo-tools input[type=file]{display:inline-block}
</style>
</head>
<body class="gated">
<header>
  <div class="brand">Bin Back In Solutions</div>
  <select id="areaSel" class="areaSel app-only" title="Area"><option value="All">All areas</option></select>
  <button id="addArea" class="btn app-only" type="button">+ Area</button>
  <div class="spacer"></div>
  <div class="seg app-only" id="daySeg">
    <button data-day="All" class="active">All</button>
    <button data-day="Tuesday">Tue</button>
    <button data-day="Wednesday">Wed</button>
    <button data-day="Thursday">Thu</button>
    <button data-day="Friday">Fri</button>
  </div>
  <button id="addBtn" class="btn app-only" type="button">+ Address</button>
  <button id="userBtn" class="btn app-only" type="button">User</button>
</header>

<!-- Gate: top/bottom halves -->
<div id="gate">
  <div class="gcard" id="binCard">
    <h2 class="gtitle">BinBackIn</h2>
    <div class="muted">Business login</div>
    <div class="field"><input id="binPass" placeholder="Enter code" inputmode="numeric" maxlength="12" /></div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="field" style="flex:1">
        <select id="binOpenArea" class="areaSel" style="width:100%"></select>
      </div>
      <div class="field" style="flex:1">
        <input id="binAreaCode" placeholder="Enter code" inputmode="numeric" maxlength="12" />
      </div>
      <button id="binOpenBtn" class="btn primary" type="button">Open area</button>
    </div>
  </div>

  <div class="gcard" id="pmCard">
    <h2 class="gtitle">Property Manager</h2>
    <div class="muted">Manager login</div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <div class="field" style="flex:1">
        <select id="pmArea" class="areaSel" style="width:100%"></select>
      </div>
      <div class="field" style="flex:1">
        <input id="pmCode" placeholder="Enter code" inputmode="numeric" maxlength="12" />
      </div>
      <button id="pmOpen" class="btn" type="button">View area</button>
    </div>
  </div>
</div>

<main>
  <div class="toolbar app-only">
    <div class="search"><span>üîé</span><input id="search" placeholder="Search address‚Ä¶" /></div>
    <button id="refresh" class="btn" type="button">Refresh</button>
    <button id="optimiseOut" class="btn" type="button">Optimise Out</button>
    <button id="optimiseBack" class="btn" type="button">Optimise Back</button>
  </div>
  <div id="status" class="banner">Booting‚Ä¶</div>
  <h2 style="margin:10px 0 12px 0;"><span id="areaTitle">All areas</span> ‚Äî Addresses</h2>
  <div id="list"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, addDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import * as ST from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAaDT6hFD38_P1AhQMF_vT18tXG9_pp8Sw",
  authDomain: "binbackinsolutions.firebaseapp.com",
  projectId: "binbackinsolutions",
  storageBucket: "binbackinsolutions.firebasestorage.app",
  messagingSenderId: "740345071529",
  appId: "1:740345071529:web:e960f05ba0c982194126b8",
  measurementId: "G-6XK5H9LWWK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- helpers ----------
const $=s=>document.querySelector(s);
const statusEl=$("#status"); function setBanner(t){ statusEl.textContent=t; }
const LS_AREAS='bbi_areas_v1';
const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
function fmtShort(ts){ if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})+' ¬∑ '+d.toLocaleDateString([], {weekday:'short'})+' '+d.toLocaleDateString([], {day:'2-digit',month:'short'}); }

// App state
let filterDay='All', filterText='', filterArea='All';
let FULL_SCOPE=false; // admin true = subscribeAll; managers false = subscribeArea
let ADDRS=[];
let AREAS = JSON.parse(localStorage.getItem(LS_AREAS) || '["Queenstown","Tikipunga Retirement"]');

(async ()=>{ setBanner("Signing in‚Ä¶"); await signInAnonymously(auth); setBanner("Connected"); hydrateAreas(); })();

function hydrateAreas(){
  const fill = (sel)=>{ sel.innerHTML=''; for(const a of AREAS){ const o=document.createElement('option'); o.value=a; o.textContent=a; sel.appendChild(o); } };
  fill($("#pmArea")); fill($("#binOpenArea"));
  $("#areaSel").innerHTML='<option value="All">All areas</option>'+AREAS.map(a=>`<option>${a}</option>`).join('');
}

$("#addArea").addEventListener('click', ()=>{ const name=prompt('New area name:'); if(!name) return; if(!AREAS.includes(name)) AREAS.push(name); localStorage.setItem(LS_AREAS, JSON.stringify(AREAS)); hydrateAreas(); });

// Gate logic (no on-screen hints)
const MASTER_BIN='9999';
const DEFAULT_CODE='0000';

async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function verifyAreaCode(areaName, code){
  if(!code) return false;
  const d = await getDoc(doc(db,'areas', slug(areaName)));
  if(!d.exists()) return code === DEFAULT_CODE;
  const h = await sha256Hex(code);
  return (d.data().passHash === h);
}

$("#pmOpen").addEventListener('click', async ()=>{ 
  const area=$("#pmArea").value; const code=($("#pmCode").value||'').trim(); 
  const ok=await verifyAreaCode(area, code); if(!ok) return alert('Incorrect code');
  FULL_SCOPE=false; await openArea(area);
});

$("#binOpenBtn").addEventListener('click', async ()=>{ 
  const pass=($("#binPass").value||'').trim(); if(pass!==MASTER_BIN) return alert('Incorrect code');
  const area=$("#binOpenArea").value; const code=($("#binAreaCode").value||'').trim();
  const ok=await verifyAreaCode(area, code); if(!ok) return alert('Incorrect area code');
  FULL_SCOPE=true; await openArea(area);
});

// Core UI
const areaSel=$("#areaSel"), areaTitle=$("#areaTitle");
areaSel.addEventListener('change', ()=>{ filterArea=areaSel.value; renderAreas(); render(); });
document.getElementById('daySeg').addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; document.querySelectorAll('#daySeg button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); filterDay=b.getAttribute('data-day'); render(); });
document.getElementById('search').addEventListener('input', e=>{ filterText=e.target.value.toLowerCase(); render(); });
document.getElementById('refresh').addEventListener('click', ()=> location.reload());

function renderAreas(){
  $("#areaSel").innerHTML='<option value="All">All areas</option>'+AREAS.map(a=>`<option ${a===filterArea?'selected':''}>${a}</option>`).join('');
  areaTitle.textContent = filterArea==='All'?'All areas':filterArea;
}

function statusLine(label, who, when){ return (who && when) ? `<span class="label">${label}</span> ‚Äî <span class="who">${who}</span> ‚Äî <span class="time">${fmtShort(when)}</span>` : '&nbsp;'; }

function applyFilters(arr){
  return arr.filter(it=>{
    const dayOK=(filterDay==='All'||it.pickup===filterDay);
    const txtOK=(!filterText||it.address?.toLowerCase().includes(filterText));
    const area=String(it.area||'Queenstown').trim();
    const areaOK=(filterArea==='All'||area.toLowerCase()===filterArea.toLowerCase());
    return dayOK&&txtOK&&areaOK;
  });
}

function openInMaps(query){ if(!query) return; const encoded=encodeURIComponent(String(query).trim()); const isIOS=/iPad|iPhone|iPod/i.test(navigator.userAgent); const url=isIOS?`maps://?q=${encoded}`:`https://www.google.com/maps/search/?api=1&query=${encoded}`; const w=window.open(url,'_blank','noopener'); if(!w) window.location.href=url; }

function render(){
  const listEl=$("#list"); listEl.innerHTML='';
  const sorted = ADDRS.slice().sort((a,b)=>{ const ra = (typeof a.rank==='number')?a.rank:1e9; const rb=(typeof b.rank==='number')?b.rank:1e9; if(ra!==rb) return ra-rb; return (a.address||'').localeCompare(b.address||''); });
  for(const it of applyFilters(sorted)){
    const area = String(it.area||'Queenstown').trim();
    const row=document.createElement('div'); row.className='addr'; row.dataset.id=it.id;
    const outL = statusLine('Out', it.outBy, it.outAt);
    const backL = statusLine('Back', it.backBy, it.backAt);
    const q = `${it.address||''}, ${area}`;
    row.innerHTML=`
      <div class="topline">
        <div class="name">${it.address||''}</div>
        <div class="meta">
          <span class="badge">üìç ${area}</span>
          <span class="badge">üóì ${it.pickup||''}</span>
          <button class="icon-btn del app-only" type="button" data-act="delete" data-id="${it.id}" aria-label="Delete address" title="Delete">‚àí</button>
        </div>
      </div>
      <div class="actions">
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
          <div class="statusline" id="stat-out-${it.id}">${outL}</div>
        </div>
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
          <div class="statusline" id="stat-back-${it.id}">${backL}</div>
        </div>
        <a class="maplink" href="javascript:void(0)" data-q="${q}" data-act="map">Address map</a>
      </div>
      <div class="bbi-photo-wrap" data-id="${it.id}">
        <div class="bbi-thumb"><img alt="Photo"></div>
        <div class="bbi-photo-cap"></div>
        <div class="bbi-photo-tools">
          <input type="file" accept="image/*" data-id="${it.id}">
        </div>
      </div>
      <textarea class="note app-only" data-id="${it.id}" maxlength="120" placeholder="Notes"
        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false" inputmode="text"></textarea>
    `;
    const ta=row.querySelector('textarea.note'); if(ta) ta.value = it.note?String(it.note):"";
    listEl.appendChild(row);
  }
  document.querySelectorAll('textarea.note').forEach(el=>{ el.style.height='auto'; const h=Math.min(el.scrollHeight,78); el.style.height=Math.max(30,h)+'px'; });
  document.querySelectorAll('.bbi-photo-wrap').forEach(wrap=> activatePhoto(wrap));
}

// Firestore subscriptions
async function subscribeAll(){
  const qy = query(collection(db,'addresses'), orderBy('address'));
  onSnapshot(qy, (snap)=>{ ADDRS=snap.docs.map(d=>({id:d.id, ...d.data()})); render(); setBanner('Live ‚Äî synced'); });
}
async function subscribeArea(areaName){
  const qy = query(collection(db,'addresses'), where('area','==',areaName));
  onSnapshot(qy, (snap)=>{ ADDRS=snap.docs.map(d=>({id:d.id, ...d.data()})); render(); setBanner('Live ‚Äî synced'); });
}
async function openArea(area){
  filterArea=area;
  if(FULL_SCOPE) await subscribeAll(); else await subscribeArea(area);
  document.body.classList.remove('gated');
  document.getElementById('gate').style.display='none';
  renderAreas();
}

// Interactions
document.getElementById('list').addEventListener('change', async (e)=>{ 
  const cb=e.target.closest('input[type=checkbox]'); if(!cb) return;
  const id=cb.getAttribute('data-id'), act=cb.getAttribute('data-act'); const t=Date.now(); const who='User';
  const patch={ updatedAt:t };
  if(act==='out'){ patch.out=cb.checked; patch.outBy=cb.checked?who:""; patch.outAt=cb.checked?t:0; }
  if(act==='back'){ patch.back=cb.checked; patch.backBy=cb.checked?who:""; patch.backAt=cb.checked?t:0; }
  try{ await updateDoc(doc(db,'addresses',id), patch); }catch(err){ alert('Update failed'); }
});

const SAVE_T=new Map();
document.getElementById('list').addEventListener('input', (e)=>{
  const ta=e.target.closest('textarea.note'); if(!ta) return;
  const id=ta.getAttribute('data-id'); const v=ta.value.slice(0,120);
  ta.style.height='auto'; ta.style.height=Math.max(30, Math.min(ta.scrollHeight,78))+'px';
  if(SAVE_T.has(id)) clearTimeout(SAVE_T.get(id));
  SAVE_T.set(id, setTimeout(async ()=>{ try{ await updateDoc(doc(db,'addresses',id), { note:v, updatedAt:Date.now() }); }catch(e){} SAVE_T.delete(id); }, 800));
}, true);

document.getElementById('list').addEventListener('click', (e)=>{
  const a=e.target.closest('[data-act="map"]'); if(a){ e.preventDefault(); openInMaps(a.getAttribute('data-q')); return; }
  const del=e.target.closest('[data-act="delete"]'); if(del){ if(!confirm('Remove this address?')) return; (async ()=>{ try{ await deleteDoc(doc(db,'addresses',del.getAttribute('data-id'))); }catch(e){ alert('Delete failed'); } })(); }
}, {passive:false});

// ADD ADDRESS ‚Äî working
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const area = (filterArea==='All') ? (prompt('Area name for this address:', AREAS[0]||'Queenstown') || '').trim() : filterArea;
  if(!area) return;
  const address = (prompt('Street address:') || '').trim(); if(!address) return;
  const pickup = prompt('Pickup day (e.g., Tuesday, Wednesday, Thursday, Friday):', 'Tuesday') || 'Tuesday';
  try{
    await addDoc(collection(db,'addresses'), { address, area, pickup, out:false, back:false, note:'', updatedAt:Date.now() });
  }catch(e){ alert('Add failed'); }
});

// ---- Photo injector ----
function ensureLightbox(){
  if(document.getElementById('bbi-lightbox')) return;
  const box=document.createElement('div'); box.id='bbi-lightbox'; box.style.cssText='position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000c;z-index:9999;';
  const inner=document.createElement('img'); inner.style.cssText='max-width:96vw;max-height:92vh;display:block;border-radius:8px;'; inner.alt='Photo';
  box.appendChild(inner); box.addEventListener('click', ()=>{ box.style.display='none'; document.documentElement.style.overflow=''; });
  document.body.appendChild(box);
}
function openLightbox(src){
  ensureLightbox();
  const box=document.getElementById('bbi-lightbox'); const img=box.querySelector('img'); img.src=src; document.documentElement.style.overflow='hidden'; box.style.display='flex';
}

function activatePhoto(wrap){
  if(wrap.__active) return; wrap.__active=true;
  const id=wrap.getAttribute('data-id');
  const img=wrap.querySelector('img'); const thumb=wrap.querySelector('.bbi-thumb'); const cap=wrap.querySelector('.bbi-photo-cap');
  const inp=wrap.querySelector('input[type=file]');

  (async ()=>{ try{ const storage=ST.getStorage(app); const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`)); img.src=url+'#'+Date.now(); thumb.style.display='block'; }catch(_ ){ thumb.style.display='none'; } })();
  (async ()=>{ try{ const d=await getDoc(doc(db,'addresses',id)); if(d.exists()){ const v=d.data(); cap.textContent=(v.photoBy && v.photoAt) ? `Last updated by ${v.photoBy} at ${fmtShort(v.photoAt)}` : ''; } }catch(_ ){ cap.textContent=''; } })();

  thumb.addEventListener('click', async ()=>{ if(!img.src) return; try{ const storage=ST.getStorage(app); const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`)); openLightbox(url+'#'+Date.now()); }catch(_ ){ openLightbox(img.src); } });

  inp.addEventListener('change', async ()=>{ const f=inp.files && inp.files[0]; if(!f) return;
    try{ const storage=ST.getStorage(app); await ST.uploadBytes(ST.ref(storage, `addresses/${id}/latest.jpg`), f, { contentType: f.type||'image/jpeg', cacheControl:'no-cache' });
      await setDoc(doc(db,'addresses',id), { photoBy:'User', photoAt:Date.now() }, { merge:true });
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`)); img.src=url+'#'+Date.now(); thumb.style.display='block';
    }catch(err){ alert('Upload failed'); } finally{ inp.value=''; }
  });
}
</script>
</body>
</html>
