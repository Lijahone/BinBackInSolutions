<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<style>
  :root{ --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; --brand:#2563eb; }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
    padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:10;flex-wrap:wrap}
  .brand{font-weight:800;font-size:18px}
  .spacer{flex:1}
  .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer;font-weight:600}
  .seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
  .seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
  .seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
  main{max-width:900px;margin:0 auto;padding:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
    background:var(--card);padding:8px 12px;border-radius:12px;min-width:180px}
  .search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
  .addr{display:grid;gap:10px;border:1px solid var(--border);border-radius:16px;padding:14px 12px;margin-bottom:10px;background:var(--card)}
  .topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .name{font-weight:800}
  .meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
  .actions{display:flex;gap:12px 14px;align-items:flex-start;flex-wrap:wrap}
  .actions > *{flex:0 0 auto;} /* lock width to content to avoid wrap changes */
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .icon-btn{border:0;background:transparent;font-size:18px;line-height:1;padding:2px 6px;border-radius:4px;color:var(--muted);cursor:pointer}
  .maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
  .note{width:100%;font-size:16px;line-height:1.35;padding:6px 10px;border:1px solid var(--border);border-radius:10px;resize:none;overflow:hidden;height:30px;min-height:30px;max-height:78px;background:transparent}
  .note::placeholder{color:var(--muted);opacity:.75}

  /* No-bounce reservation under each toggle */
  .toggleWrap{display:flex;flex-direction:column;align-items:flex-start;gap:2px;min-height:86px}
  .byname{cursor:pointer;color:var(--muted);font-weight:700;font-size:14px;padding:4px 6px;border-radius:6px}
  .whoLine{height:20px;line-height:20px;font-size:14px;color:var(--muted)}
  .whoLine.empty{visibility:hidden}
  .hintline{height:18px;line-height:18px;font-size:12px;color:var(--muted);opacity:0;transition:opacity .4s;margin-left:4px}
  .hintline.show{opacity:1}
</style>
</head>
<body>
<header>
  <div class="brand">Bin Back In Solutions</div>
  <div class="spacer"></div>
  <div class="seg" id="daySeg">
    <button data-day="All" class="active">All</button>
    <button data-day="Tuesday">Tue</button>
    <button data-day="Wednesday">Wed</button>
    <button data-day="Thursday">Thu</button>
    <button data-day="Friday">Fri</button>
  </div>
  <button id="addBtn" class="btn">+ Address</button>
  <button id="userBtn" class="btn">User</button>
</header>

<main>
  <div class="toolbar">
    <div class="search">
      <span>ðŸ”Ž</span><input id="search" placeholder="Search addressâ€¦" />
    </div>
    <button id="refresh" class="btn">Refresh</button>
    <button id="optOut" class="btn">Opt Out</button>
    <button id="optBack" class="btn">Opt Back</button>
    <button id="export" class="btn">Export</button>
    <input id="file" type="file" accept=".json" style="display:none">
    <button id="importBtn" class="btn">Import</button>
  </div>

  <div id="status" style="font-size:12px;color:var(--muted)">UI ready.</div>
  <div id="debug" style="display:none;font-size:12px;color:#b91c1c;background:#fff1f2;border:1px solid #fecdd3;border-radius:10px;padding:8px;margin-top:8px;white-space:pre-wrap"></div>

  <h2 style="margin:10px 0 12px 0;">Queenstown â€” Addresses</h2>
  <div id="list"></div>
</main>

<script>
// ---- Full address list ----
const SEED=[
  {"address":"30 Woodlands Close","pickup":"Tuesday","gas":"No"},
  {"address":"6 Goldrush Way","pickup":"Tuesday","gas":"Yes"},
  {"address":"20 Goldleaf","pickup":"Tuesday","gas":"Yes"},
  {"address":"2/64 Marina Drive","pickup":"Tuesday","gas":"Yes"},
  {"address":"34a Brisbane Street","pickup":"Tuesday","gas":"No"},
  {"address":"1/47 Lomond Cres","pickup":"Wednesday","gas":"No"},
  {"address":"39 Lomond Cres","pickup":"Wednesday","gas":"No"},
  {"address":"41 Lomond Cres","pickup":"Wednesday","gas":"No"},
  {"address":"2/11 Gum Lane","pickup":"Wednesday","gas":"No"},
  {"address":"22C Malaghan Street","pickup":"Wednesday","gas":"No"},
  {"address":"78 Highview","pickup":"Wednesday","gas":"No"},
  {"address":"70 Panorama Terrace","pickup":"Wednesday","gas":"No"},
  {"address":"7 Peregrine Place","pickup":"Wednesday","gas":"No"},
  {"address":"101 Hensman Road","pickup":"Wednesday","gas":"Yes"},
  {"address":"18 Amber Close","pickup":"Thursday","gas":"Yes"},
  {"address":"6 Redfern Terrace","pickup":"Thursday","gas":"Yes"},
  {"address":"14 Cumberland Road","pickup":"Thursday","gas":"No"},
  {"address":"12 Corriedale Road","pickup":"Friday","gas":"No"},
  {"address":"42 Muster Road","pickup":"Friday","gas":"Yes"}
];

const $=s=>document.querySelector(s);
const listEl=$("#list"); const statusEl=$("#status"); const debugEl=$("#debug");
const LS='bbi_full_opt_v2', LS_USER='bbi_user_name';
const now=()=>Date.now();
const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const fmtShort=ts=>{ if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})+' Â· '+d.toLocaleDateString([], {weekday:'short'})+' '+d.toLocaleDateString([], {day:'2-digit',month:'short'}); };

let userName=localStorage.getItem(LS_USER)||'';
let state=null; try{ state=JSON.parse(localStorage.getItem(LS)); }catch(_){}
if(!state){ state=SEED.map(o=>({id:slug(o.address),address:o.address,pickup:o.pickup,gas:o.gas,out:false,outBy:'',outAt:0,back:false,backBy:'',backAt:0,gasReplace:false,gasBy:'',gasAt:0,lat:null,lng:null,pinLat:null,pinLng:null,note:'',updatedAt:now()})); saveLocal(); }
function saveLocal(){ localStorage.setItem(LS, JSON.stringify(state)); }

// Filters
let filterDay='All', filterText='';
document.getElementById('daySeg').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  document.querySelectorAll('#daySeg button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); filterDay=b.getAttribute('data-day'); render();
});
document.getElementById('search').addEventListener('input', e=>{ filterText=e.target.value.toLowerCase(); render(); });
function applyFilters(arr){ return arr.filter(it=> (filterDay==='All'||it.pickup===filterDay) && (!filterText||it.address.toLowerCase().includes(filterText))); }

// Render helpers
function whoLineHTML(show,id,kind,name){ const text=name?`(${name})`:''; return `<div class="whoLine ${show?'':'empty'}">${show?`<span class="byname" data-id="${id}" data-kind="${kind}">${text}</span>`:''}</div>`; }
function render(){
  listEl.innerHTML='';
  for(const it of applyFilters(state)){
    const row=document.createElement('div'); row.className='addr';
    const gas=it.gas==='Yes'?`
      <div class="toggleWrap">
        <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="gasReplace" ${it.gasReplace?'checked':''}> Gas replace</label>
        ${whoLineHTML(!!(it.gasReplace&&it.gasBy), it.id, 'gas', it.gasBy)}
        <div class="hintline" id="hint-gas-${it.id}">â†³ Ticked ${fmtShort(it.gasAt)}</div>
      </div>`:'';
    row.innerHTML=`
      <div class="topline">
        <div class="name">${it.address}</div>
        <div class="meta">
          <span class="badge">ðŸ—“ ${it.pickup}</span>
          <button class="icon-btn" data-id="${it.id}" data-act="delete" title="Remove">â€“</button>
        </div>
      </div>
      <div class="actions">
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
          ${whoLineHTML(!!(it.out&&it.outBy), it.id, 'out', it.outBy)}
          <div class="hintline" id="hint-out-${it.id}">â†³ Ticked ${fmtShort(it.outAt)}</div>
        </div>
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
          ${whoLineHTML(!!(it.back&&it.backBy), it.id, 'back', it.backBy)}
          <div class="hintline" id="hint-back-${it.id}">â†³ Ticked ${fmtShort(it.backAt)}</div>
        </div>
        ${gas}
        <a class="maplink" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address+', Queenstown')}" target="_blank" rel="noopener">Address map</a>
      </div>
      <textarea class="note" data-id="${it.id}" maxlength="120" placeholder="Notes">${it.note?it.note.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''}</textarea>
    `;
    listEl.appendChild(row);
  }
  document.querySelectorAll('textarea.note').forEach(el=>{ el.style.height='auto'; const h=Math.min(el.scrollHeight,78); el.style.height=Math.max(30,h)+'px'; });
}
render();

// Name tap â†’ timestamp fade (no toggle)
listEl.addEventListener('click', (e)=>{
  const s=e.target.closest('.byname'); if(!s) return; e.preventDefault(); e.stopPropagation();
  const id=s.getAttribute('data-id'); const kind=s.getAttribute('data-kind'); const el=document.getElementById(`hint-${kind}-${id}`);
  if(!el) return; el.classList.add('show'); clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'),4000);
});

// Toggle change
listEl.addEventListener('change', (e)=>{
  const cb=e.target.closest('input[type=checkbox]'); if(!cb) return;
  const id=cb.getAttribute('data-id'), act=cb.getAttribute('data-act');
  const i=state.findIndex(x=>x.id===id); if(i<0) return;
  if(!userName){ const v=prompt('Your name (for activity log):',''); if(v===null||!v.trim()){ cb.checked=!cb.checked; return;} userName=v.trim(); localStorage.setItem(LS_USER,userName); }
  state[i][act]=cb.checked; const t=now();
  if(act==='out'){ state[i].outBy=userName; state[i].outAt=t; }
  if(act==='back'){ state[i].backBy=userName; state[i].backAt=t; }
  if(act==='gasReplace'){ state[i].gasBy=userName; state[i].gasAt=t; }
  state[i].updatedAt=t; saveLocal(); render();
});

// Notes
listEl.addEventListener('input', (e)=>{
  const ta=e.target.closest('textarea.note'); if(!ta) return; const id=ta.getAttribute('data-id'); const i=state.findIndex(x=>x.id===id); if(i<0) return;
  state[i].note=ta.value.slice(0,120); state[i].updatedAt=now(); saveLocal();
  const h=Math.min(ta.scrollHeight,78); ta.style.height=Math.max(30,h)+'px';
});

// Delete (with passcode 5952)
listEl.addEventListener('click', (e)=>{
  const del=e.target.closest('button.icon-btn'); if(!del) return;
  const id=del.getAttribute('data-id');
  if(confirm('Remove this address?') && prompt('Enter passcode to confirm delete:')==='5952'){
    state=state.filter(x=>x.id!==id); saveLocal(); render();
  }
});

// Add address (prompts for gas flag too)
document.getElementById('addBtn').addEventListener('click', ()=>{
  const addr=prompt('New address:'); if(!addr||!addr.trim()) return;
  const pickup=(prompt('Pickup day (Tuesday/Wednesday/Thursday/Friday):','Tuesday')||'Tuesday').trim();
  const gasAns=(prompt('Gas replacement required at this address? (yes/no):','no')||'no').trim().toLowerCase();
  const gas = (gasAns==='yes'||gasAns==='y') ? 'Yes' : 'No';
  const obj={id:slug(addr),address:addr.trim(),pickup,gas, out:false,outBy:'',outAt:0, back:false,backBy:'',backAt:0, gasReplace:false,gasBy:'',gasAt:0, lat:null,lng:null,pinLat:null,pinLng:null, note:'', updatedAt:now()};
  state.push(obj); saveLocal(); render();
});

// ---------- Optimisation ----------
// Uses current filters (day + search).
// Opt Out => optimise visible addresses where out==false
// Opt Back => optimise visible addresses where out==true && back==false
async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function geocode(q){
  const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
  const res=await fetch(url,{headers:{'Accept':'application/json','User-Agent':'BinBackIn/1.0'}});
  if(!res.ok) return null; const j=await res.json(); if(!j||!j.length) return null;
  return {lat:parseFloat(j[0].lat), lng:parseFloat(j[0].lon)};
}
async function ensureCoords(ids){
  for(const id of ids){
    const i=state.findIndex(x=>x.id===id); if(i<0) continue;
    if(state[i].pinLat&&state[i].pinLng) continue;
    if(state[i].lat&&state[i].lng) continue;
    try{
      const c=await geocode(state[i].address+', Queenstown'); if(c){ state[i].lat=c.lat; state[i].lng=c.lng; saveLocal(); }
      await sleep(900);
    }catch(_){}
  }
}
function dist(a,b){ const dx=a.lat-b.lat, dy=a.lng-b.lng; return Math.hypot(dx*111,dy*85); } // crude scaling
async function getStartCoord(){
  try{
    const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:4000}));
    return { lat:pos.coords.latitude, lng:pos.coords.longitude };
  }catch(_){ return null; }
}
function coordsOf(it){ return { id:it.id, lat:(it.pinLat??it.lat), lng:(it.pinLng??it.lng) }; }
function orderFromStart(start, items){
  if(!start || !items.length) return items;
  // pick closest first, then nearest neighbour
  let idx = items.reduce((bi,_,i)=> dist(start, items[i]) < dist(start, items[bi]) ? i : bi, 0);
  const used = new Set(); const route=[];
  for(let k=0;k<items.length;k++){
    used.add(idx); route.push(items[idx]);
    let best=-1, bestd=1e12;
    for(let j=0;j<items.length;j++) if(!used.has(j)){
      const d=dist(items[idx], items[j]); if(d<bestd){ bestd=d; best=j; }
    }
    if(best===-1) break; idx=best;
  }
  return route;
}
async function optimise(mode){
  // pool = items currently visible (filters) AND matching mode
  const visible = applyFilters(state);
  const pool = visible.filter(s => mode==='out' ? !s.out : (s.out && !s.back));
  if(pool.length<=1){ statusEl.textContent='Nothing to optimise for this view.'; return; }
  const ids = pool.map(s=>s.id);
  statusEl.textContent='Optimisingâ€¦ fetching coordinates';
  await ensureCoords(ids);
  const withC = pool.map(coordsOf).filter(p=>p.lat&&p.lng);
  if(withC.length<2){ statusEl.textContent='Not enough locations with coordinates.'; return; }
  const start = await getStartCoord();
  const ordered = start ? orderFromStart(start, withC) : orderFromStart(withC[0], withC);
  const orderIds = ordered.map(o=>o.id);
  // reorder only items in pool within the full state:
  const idToRank = new Map(orderIds.map((id,idx)=>[id,idx]));
  state = state.slice().sort((a,b)=>{
    const ra = idToRank.has(a.id) ? idToRank.get(a.id) : 1e9;
    const rb = idToRank.has(b.id) ? idToRank.get(b.id) : 1e9;
    return ra - rb || 0;
  });
  saveLocal(); render();
  statusEl.textContent = `${mode==='out'?'Opt Out':'Opt Back'}: reordered ${orderIds.length} of ${pool.length} visible addresses` + (start?' from your current location.':'.');
}
document.getElementById('optOut').addEventListener('click', ()=>optimise('out'));
document.getElementById('optBack').addEventListener('click', ()=>optimise('back'));

</script>
</body>
</html>
