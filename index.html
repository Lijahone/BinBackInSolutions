<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions ‚Äî Live</title>
<style>
  :root{ --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; --brand:#2563eb; }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
    padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:10;flex-wrap:wrap}
  .brand{font-weight:800;font-size:18px}
  .spacer{flex:1}
  .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer;font-weight:600}
  .seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
  .seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
  .seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
  main{max-width:920px;margin:0 auto;padding:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
    background:var(--card);padding:8px 12px;border-radius:12px;min-width:180px}
  .search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
  .addr{display:grid;gap:10px;border:1px solid var(--border);border-radius:16px;padding:14px 12px;margin-bottom:12px;background:var(--card);position:relative}
  .topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .name{font-weight:800}
  .meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
  .actions{display:flex;gap:12px 14px;align-items:flex-start;flex-wrap:wrap}
  .actions > *{flex:0 0 auto;}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
  .note{width:100%;font-size:16px;line-height:1.35;padding:6px 10px;border:1px solid var(--border);border-radius:10px;resize:none;overflow:hidden;height:30px;min-height:30px;max-height:78px;background:transparent}
  .statusline{height:22px;line-height:22px;font-size:13px;color:var(--muted)}
  .statusline .label{font-weight:700;color:var(--ink)}
  .statusline .who{font-weight:700}
  .statusline .time{opacity:.9}

  /* Photo block (above notes) */
  .photo-wrap{display:grid;grid-template-columns:120px 1fr;gap:14px;margin-top:6px;
    padding:12px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#ffffff 0%, #fafbff 100%);}
  @media (prefers-color-scheme: dark){
    .photo-wrap{background:linear-gradient(180deg,#101628 0%, #0d1426 100%);}
  }
  .thumb{width:120px;height:120px;border-radius:12px;border:1px solid #e5e7eb;overflow:hidden;background:#f4f6fb;
    display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .tools{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pbtn{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
  .sbtn{padding:10px 14px;border:0;border-radius:10px;background:#eef2ff;color:#1e40af;font-weight:700;cursor:pointer}
  .cap{font-size:12px;color:#667085}
  .progress{height:8px;background:#eef2ff;border-radius:8px;overflow:hidden;display:none}
  .progress > div{height:8px;width:0%;background:#3b82f6;transition:width .18s ease}
  @media (prefers-color-scheme: dark){
    .thumb{border-color:#2a3352;background:#151c33}
    .progress{background:#1c2542}
    .progress > div{background:#3b82f6}
    .cap{color:#9aa1b2}
  }

  /* toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 14px;background:rgba(0,0,0,0.9);color:#fff;border-radius:8px;font-size:14px;z-index:99999;opacity:0;transition:opacity .18s ease}
</style>
</head>
<body>
<header>
  <div class="brand">Bin Back In Solutions</div>
  <div class="spacer"></div>
  <button id="userBtn" class="btn" type="button">User</button>
</header>

<main>
  <div class="toolbar">
    <div class="search"><span>üîé</span><input id="search" placeholder="Search address‚Ä¶" /></div>
    <button id="refresh" class="btn" type="button">Refresh</button>
  </div>

  <div id="status" class="badge" style="display:inline-flex">Booting‚Ä¶</div>

  <h2 style="margin:10px 0 12px 0;">Addresses</h2>
  <div id="list"></div>
</main>

<!-- Display Name Modal -->
<div class="toast" id="toast"></div>

<script type="module">
// Firebase core
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import * as ST from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

// Config: BinBackInSolutions / correct bucket
const firebaseConfig = {
  apiKey: "AIzaSyAaDT6hFD38_P1AhQMF_vT18tXG9_pp8Sw",
  authDomain: "binbackinsolutions.firebaseapp.com",
  projectId: "binbackinsolutions",
  storageBucket: "binbackinsolutions.appspot.com",
  appId: "1:740345071529:web:e960f05ba0c982194126b8",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
window.db = db;
window.CURRENT_USER = localStorage.getItem('bbi_user_name') || '';

// ---------- utilities ----------
const $=s=>document.querySelector(s);
const statusEl=$("#status");
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 1600); }
function fmtShort(ts){ if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})+' ¬∑ '+d.toLocaleDateString([], {weekday:'short'})+' '+d.toLocaleDateString([], {day:'2-digit',month:'short'}); }

// ---------- render ----------
let ADDRS=[];
let filterText='';
function applyFilters(arr){
  return arr.filter(it=> !filterText || (it.address||'').toLowerCase().includes(filterText) );
}
function render(){
  const list=$("#list"); list.innerHTML='';
  for(const it of applyFilters(ADDRS)){
    const row=document.createElement('div'); row.className='addr'; row.dataset.id=it.id;

    // Photo block (ABOVE notes)
    const photo = document.createElement('div');
    photo.className='photo-wrap';
    photo.innerHTML = `
      <div class="thumb"><img alt="No photo"></div>
      <div class="tools">
        <div class="row">
          <button class="pbtn pick" type="button">Add/Replace photo</button>
          <button class="sbtn view" type="button">View full size</button>
          <input type="file" accept="image/*" capture="environment" style="display:none">
        </div>
        <div class="progress"><div></div></div>
        <div class="cap">No photo yet</div>
      </div>`;

    const header = document.createElement('div');
    header.className='topline';
    header.innerHTML = `
      <div class="name">${it.address||''}</div>
      <div class="meta">
        <span class="badge">üìç ${it.area||'Queenstown'}</span>
        <span class="badge">üóì ${it.pickup||''}</span>
      </div>`;

    const outL = (it.outBy&&it.outAt)?`<span class="label">Out</span> ‚Äî <span class="who">${it.outBy}</span> ‚Äî <span class="time">${fmtShort(it.outAt)}</span>`:'&nbsp;';
    const backL = (it.backBy&&it.backAt)?`<span class="label">Back</span> ‚Äî <span class="who">${it.backBy}</span> ‚Äî <span class="time">${fmtShort(it.backAt)}</span>`:'&nbsp;';

    const actions = document.createElement('div');
    actions.className='actions';
    const addrStr = `${it.address||''}, ${it.area||'Queenstown'}`;
    actions.innerHTML = `
      <div>
        <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
        <div class="statusline" id="stat-out-${it.id}">${outL}</div>
      </div>
      <div>
        <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
        <div class="statusline" id="stat-back-${it.id}">${backL}</div>
      </div>
      <a class="maplink" href="javascript:void(0)" data-q="${addrStr}" data-act="map">Address map</a>
    `;

    const notes = document.createElement('textarea');
    notes.className='note';
    notes.placeholder='Notes';
    notes.value = it.note ? String(it.note) : "";
    notes.setAttribute('data-id', it.id);

    row.appendChild(header);
    row.appendChild(photo);
    row.appendChild(actions);
    row.appendChild(notes);

    $("#list").appendChild(row);
    activatePhoto(photo, it.id);
  }

  // auto-size notes
  document.querySelectorAll('textarea.note').forEach(el=>{ el.style.height='auto'; const h=Math.min(el.scrollHeight,78); el.style.height=Math.max(30,h)+'px'; });
}

// ---------- photo logic ----------
async function compressImage(file, {maxSide=1600, quality=0.72, mime='image/jpeg'}={}){
  const fr = new FileReader();
  const dataURL = await new Promise((res, rej)=>{ fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
  const img = new Image(); img.decoding='async'; img.style.imageOrientation='from-image';
  await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=dataURL; });
  let {width, height} = img;
  if (Math.max(width,height) > maxSide){
    if (width >= height){ height = Math.round(height*(maxSide/width)); width = maxSide; }
    else { width = Math.round(width*(maxSide/height)); height = maxSide; }
  }
  const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height;
  const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,width,height);
  const blob = await new Promise(res => canvas.toBlob(res, mime, quality));
  return new File([blob], 'latest.jpg', {type:mime, lastModified: Date.now()});
}
function activatePhoto(wrap, id){
  const img = wrap.querySelector('img');
  const cap = wrap.querySelector('.cap');
  const pick = wrap.querySelector('.pick');
  const view = wrap.querySelector('.view');
  const prog = wrap.querySelector('.progress');
  const bar = wrap.querySelector('.progress > div');
  const inp = wrap.querySelector('input[type=file]');

  const who = window.CURRENT_USER || 'User';

  const BUCKET = "gs://binbackinsolutions.appspot.com";

  // load existing
  (async ()=>{
    try {
      const storage = ST.getStorage(app, BUCKET);
      const url = await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      img.src = url + '#' + Date.now();
    } catch(_) {}
    try {
      const snap = await getDoc(doc(db,'addresses', id));
      const data = snap && snap.data && snap.data();
      if(data&&data.photoAt){
        cap.textContent = `Last photo by ${data.photoBy||'User'} at ${fmtShort(data.photoAt)}`;
      }
    }catch(_){}
  })();

  // view
  view.addEventListener('click', ()=>{
    if(!img.src) return;
    const b=document.createElement('div');
    Object.assign(b.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.8)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999});
    const big=new Image(); big.src=img.src; big.style.maxWidth='96vw'; big.style.maxHeight='92vh'; big.style.borderRadius='12px';
    b.appendChild(big); b.addEventListener('click',()=>document.body.removeChild(b));
    document.body.appendChild(b);
  });

  pick.addEventListener('click', ()=> inp.click());
  inp.addEventListener('change', async ()=>{
    const f = inp.files && inp.files[0]; if(!f) return;
    prog.style.display='block'; bar.style.width='0%';
    let small = f;
    try {
      for(const step of [{maxSide:1600,quality:0.72},{maxSide:1366,quality:0.68},{maxSide:1200,quality:0.65},{maxSide:1024,quality:0.62}]){
        small = await compressImage(small, step);
        if(small.size <= 320*1024) break;
      }
    } catch {}
    try { img.src = URL.createObjectURL(small); } catch {}
    cap.textContent = 'Uploading‚Ä¶ 0%';
    try{
      const storage = ST.getStorage(app, BUCKET);
      const refPath = ST.ref(storage, `addresses/${id}/latest.jpg`);
      const task = ST.uploadBytesResumable(refPath, small, { contentType: small.type||'image/jpeg', cacheControl:'no-cache' });
      await new Promise((resolve, reject)=>{
        const tm = setTimeout(()=>reject(new Error('timeout')), 45000);
        task.on('state_changed',
          snap => { const pct = Math.round((snap.bytesTransferred/Math.max(1,snap.totalBytes))*100); bar.style.width=pct+'%'; cap.textContent='Uploading‚Ä¶ '+pct+'%'; },
          err => { clearTimeout(tm); reject(err); },
          ()  => { clearTimeout(tm); resolve(); }
        );
      });
      const url = await ST.getDownloadURL(refPath);
      const now = Date.now();
      img.src = url + '#' + now;
      cap.textContent = `Last photo by ${who} at ${fmtShort(now)}`;
      await updateDoc(doc(db,'addresses', id), { photoAt: now, photoBy: who, updatedAt: now });
      toast(`Photo replaced ‚úì (${Math.round(small.size/1024)} KB)`);
    }catch(e){
      cap.textContent = `Upload failed ‚Äî ${e?.code||''} ${e?.message||''}`;
    }finally{
      setTimeout(()=>{ prog.style.display='none'; }, 800);
      inp.value='';
    }
  });
}

// ---------- toggles / notes ----------
document.getElementById('list').addEventListener('change', async (e)=>{
  const cb=e.target.closest('input[type=checkbox]'); if(!cb) return;
  const id=cb.getAttribute('data-id'), act=cb.getAttribute('data-act');
  const t=Date.now(), who=(window.CURRENT_USER||'User');
  const patch={ updatedAt:t };
  if(act==='out'){ patch.out=cb.checked; patch.outBy=cb.checked?who:""; patch.outAt=cb.checked?t:0; }
  if(act==='back'){ patch.back=cb.checked; patch.backBy=cb.checked?who:""; patch.backAt=cb.checked?t:0; }
  try{ await updateDoc(doc(db,'addresses',id), patch); }catch(err){ toast('Update failed'); }
});
const SAVE_T=new Map();
document.getElementById('list').addEventListener('input', (e)=>{
  const ta=e.target.closest('textarea.note'); if(!ta) return;
  const id=ta.getAttribute('data-id'); const v=ta.value.slice(0,120);
  ta.style.height='auto'; ta.style.height=Math.max(30, Math.min(ta.scrollHeight,78))+'px';
  if(SAVE_T.has(id)) clearTimeout(SAVE_T.get(id));
  SAVE_T.set(id, setTimeout(async ()=>{
    try{ await updateDoc(doc(db,"addresses",id), { note:v, updatedAt:Date.now() }); }catch(e){}
    SAVE_T.delete(id);
  }, 700));
}, true);

// ---------- search / map ----------
document.getElementById('search').addEventListener('input', e=>{ filterText=e.target.value.toLowerCase(); render(); });
document.getElementById('refresh').addEventListener('click', ()=> location.reload());
document.getElementById('list').addEventListener('click', (e)=>{
  const a = e.target.closest('[data-act="map"]'); if(!a) return;
  e.preventDefault();
  const q=a.getAttribute('data-q');
  const isIOS = /iPad|iPhone|iPod/i.test(navigator.userAgent);
  const url = isIOS ? `maps://?q=${encodeURIComponent(q)}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  const w = window.open(url,'_blank','noopener'); if(!w) window.location.href=url;
}, {passive:false});

// ---------- start ----------
async function start(){
  statusEl.textContent="Signing in‚Ä¶";
  await signInAnonymously(auth);
  await new Promise(res=>onAuthStateChanged(auth,u=>u&&res(u)));
  statusEl.textContent="Connecting‚Ä¶";
  const qy = query(collection(db,"addresses"), orderBy("address"));
  onSnapshot(qy, (snap)=>{
    ADDRS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    render();
    statusEl.textContent="Live ‚Äî synced";
  });
}
start();
</script>
</body>
</html>
