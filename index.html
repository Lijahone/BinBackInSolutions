<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<style>
  :root{
    --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --brand:#2563eb; --brand-ink:#fff;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
    padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:10;flex-wrap:wrap}
  .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
  .spacer{flex:1}
  .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);
    cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);color:var(--brand-ink);border-color:transparent}
  .btn.ghost{background:transparent}
  .seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
  .seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
  .seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
  main{max-width:900px;margin:0 auto;padding:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
    background:var(--card);padding:8px 12px;border-radius:12px}
  .search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
  .section{background:transparent;padding:0;margin-bottom:12px}
  .addr{display:grid;grid-template-columns:1fr;gap:10px;border:1px solid var(--border);
    border-radius:16px;padding:14px 12px;margin-bottom:10px;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .name{font-weight:800;letter-spacing:.2px}
  .meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
  .actions{display:flex;gap:10px 12px;align-items:flex-start;flex-wrap:wrap}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .toggle input{width:20px;height:20px}
  .maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
  .mini-map{height:180px;border:1px solid var(--border);border-radius:12px;margin-top:4px;width:100%}
  #status{font-size:12px;color:var(--muted)}
  #debug{font-size:12px;color:#b91c1c;white-space:pre-wrap;background:#fff1f2;border:1px solid #fecdd3;border-radius:10px;padding:8px;margin-top:8px;display:none}
  /* Icon minus button (subtle) */
  .icon-btn{border:0;background:transparent;font-size:18px;line-height:1;padding:2px 6px;border-radius:4px;color:var(--muted);cursor:pointer;transition:none}
  .icon-btn:hover{background:transparent;color:var(--muted)}

  /* Per-card notes */
  .noteRow{margin-top:6px}
  .note{
    width:100%;
    box-sizing:border-box;
    font-size:16px;           /* avoid iOS zoom */
    line-height:1.35;
    padding:6px 10px;
    border:1px solid var(--border);
    border-radius:10px;
    resize:none;
    overflow:hidden;
    background:transparent;
    color:var(--ink);
    height:30px;              /* start: single line */
    min-height:30px;
    max-height:78px;          /* ~ up to 3 lines */
  }
  .note::placeholder{color:var(--muted);opacity:.75}

  /* Inline '(Name)' and timestamp hint under toggles */
  .byname{cursor:pointer; color:var(--muted); font-weight:600}
  .whoLine{height:16px; line-height:16px; font-size:12px; color:var(--muted);} /* reserve space */
  .whoLine.empty{visibility:hidden;}
  .hintline{font-size:12px; color:var(--muted); opacity:0; transition:opacity .4s; height:0; overflow:hidden; margin-left:4px}
  .hintline.show{opacity:1; height:auto; margin-top:2px}

  /* Overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay .panel{width:min(700px,95vw);height:min(70vh,520px);background:#fff;border-radius:12px;display:flex;flex-direction:column;overflow:hidden}
  .overlay header{position:relative;border-bottom:1px solid var(--border)}
</style>
</head>
<body>
<header>
  <div class="brand">Bin Back In Solutions</div>
  <div class="spacer"></div>
  <div class="seg" id="daySeg">
    <button data-day="All" class="active">All</button>
    <button data-day="Tuesday">Tue</button>
    <button data-day="Wednesday">Wed</button>
    <button data-day="Thursday">Thu</button>
    <button data-day="Friday">Fri</button>
  </div>
  <button id="addBtn" class="btn">+ Address</button>
  <button id="userBtn" class="btn">User</button>
</header>

<main>
  <div class="toolbar">
    <div class="search">
      <span>ðŸ”Ž</span>
      <input id="search" placeholder="Search addressâ€¦" />
    </div>
    <button id="refresh" class="btn ghost">Refresh</button>
    <button id="opt" class="btn ghost">Optimize</button>
    <button id="export" class="btn ghost">Export</button>
    <input id="file" type="file" accept=".json" style="display:none">
    <button id="importBtn" class="btn ghost">Import</button>
  </div>

  <div class="section">
    <div id="status">Connectingâ€¦</div>
    <div id="debug"></div>
  </div>

  <div class="section">
    <h2 style="margin:6px 0 12px 0;">Queenstown â€” Addresses</h2>
    <div id="list"></div>
  </div>
</main>

<!-- Fullscreen Map Overlay -->
<div id="overlay" class="overlay">
  <div class="panel">
    <header style="display:flex;gap:8px;align-items:center;padding:10px 12px">
      <div id="overlayTitle" class="brand" style="font-size:16px">Set Pin</div>
      <div class="spacer"></div>
      <button id="cancelPin" class="btn">Cancel</button>
      <button id="savePin" class="btn primary">Save</button>
    </header>
    <div id="bigMap" style="flex:1"></div>
    <div style="padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;background:#fff">
      <label>Label:</label><input id="pinLabel" placeholder="e.g., by mailbox" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px">
      <button id="useGPS" class="btn">Use GPS</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<script>
// Show errors inline so the app never looks blank
window.addEventListener('error', (e)=>{
  const dbg = document.getElementById('debug');
  if (dbg) { dbg.style.display='block'; dbg.textContent = 'Error: ' + (e?.message || e.error || e); }
  const st = document.getElementById('status'); if (st) st.textContent = 'Error loading app â€” see details below.';
});

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAaDT6hFD38_P1AhQMF_vT18tXG9_pp8Sw",
  authDomain: "binbackinsolutions.firebaseapp.com",
  projectId: "binbackinsolutions",
  storageBucket: "binbackinsolutions.appspot.com",
  messagingSenderId: "740345071529",
  appId: "1:740345071529:web:e960f05ba0c982194126b8",
  measurementId: "G-6XK5H9LWWK"
};

const SEED = [
  {"address":"30 Woodlands Close", "pickup":"Tuesday", "gas":"No"},
  {"address":"6 Goldrush Way", "pickup":"Tuesday", "gas":"Yes"},
  {"address":"20 Goldleaf", "pickup":"Tuesday", "gas":"Yes"},
  {"address":"2/64 Marina Drive", "pickup":"Tuesday", "gas":"Yes"},
  {"address":"34a Brisbane Street", "pickup":"Tuesday", "gas":"No"},
  {"address":"1/47 Lomond Cres", "pickup":"Wednesday", "gas":"No"},
  {"address":"39 Lomond Cres", "pickup":"Wednesday", "gas":"No"},
  {"address":"41 Lomond Cres", "pickup":"Wednesday", "gas":"No"},
  {"address":"2/11 Gum Lane", "pickup":"Wednesday", "gas":"No"},
  {"address":"22C Malaghan Street", "pickup":"Wednesday", "gas":"No"},
  {"address":"78 Highview", "pickup":"Wednesday", "gas":"No"},
  {"address":"70 Panorama Terrace", "pickup":"Wednesday", "gas":"No"},
  {"address":"7 Peregrine Place", "pickup":"Wednesday", "gas":"No"},
  {"address":"101 Hensman Road", "pickup":"Wednesday", "gas":"Yes"},
  {"address":"18 Amber Close", "pickup":"Thursday", "gas":"Yes"},
  {"address":"6 Redfern Terrace", "pickup":"Thursday", "gas":"Yes"},
  {"address":"14 Cumberland Road", "pickup":"Thursday", "gas":"No"},
  {"address":"12 Corriedale Road", "pickup":"Friday", "gas":"No"},
  {"address":"42 Muster Road", "pickup":"Friday", "gas":"Yes"}
];

const $ = s => document.querySelector(s);
const listEl = $('#list');
const statusEl = $('#status');
const debugEl = $('#debug');
const overlay = $('#overlay');
const overlayTitle = $('#overlayTitle');
const bigMapEl = $('#bigMap');
const pinLabelEl = $('#pinLabel');
const LS = 'bbi_collab_map_full_v1';
const LS_USER = 'bbi_user_name';

function logErr(e){ if(!debugEl) return; debugEl.style.display='block'; debugEl.textContent = (e && e.message) ? e.message : String(e); }

const now = ()=>Date.now();
function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function fmtShort(ts){
  if(!ts) return '';
  const d = new Date(ts);
  const t = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
  const wd = d.toLocaleDateString([], {weekday:'short'});
  const dm = d.toLocaleDateString([], {day:'2-digit', month:'short'});
  return `${t} Â· ${wd} ${dm}`;
}

// State
let userName = localStorage.getItem(LS_USER) || '';
let state = null;
try { state = JSON.parse(localStorage.getItem(LS)); } catch(e) { state = null; }
if (!state) {
  state = SEED.map((o)=>({
    id: slug(o.address), address:o.address, pickup:o.pickup, gas:o.gas,
    out:false,outBy:'',outAt:0, back:false,backBy:'',backAt:0, gasReplace:false,gasBy:'',gasAt:0,
    lat:null,lng:null, pinLat:null,pinLng:null,pinLabel:'', note:'', updatedAt:now()
  }));
  saveLocal();
}
function saveLocal(){ localStorage.setItem(LS, JSON.stringify(state)); }

// Filters
let filterDay = 'All';
let filterText = '';
document.getElementById('daySeg').addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  document.querySelectorAll('#daySeg button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  filterDay = b.getAttribute('data-day');
  render();
});
document.getElementById('search').addEventListener('input', (e)=>{
  filterText = e.target.value.toLowerCase();
  render();
});
function applyFilters(arr){
  return arr.filter(it => {
    const dayPass = (filterDay==='All') || (it.pickup===filterDay);
    const textPass = !filterText || (it.address.toLowerCase().includes(filterText));
    return dayPass && textPass;
  });
}

// Geocoding helpers
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function geocodeNominatim(query){
  const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(query);
  const res = await fetch(url, { headers: { 'Accept':'application/json', 'User-Agent':'BinBackIn/1.0 (contact: hello@example.com)' } });
  if (!res.ok) return null;
  const data = await res.json();
  if (!data || !data.length) return null;
  return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
}
async function geocodeAllSequential(){
  for (let i=0;i<state.length;i++){
    if (state[i].lat && state[i].lng) continue;
    const q = state[i].address + ', Queenstown';
    try {
      const coord = await geocodeNominatim(q);
      if (coord) { state[i].lat = coord.lat; state[i].lng = coord.lng; saveLocal(); render(); }
      await sleep(900);
    } catch(e) {}
  }
}

// Overlay map
let currentPinId=null, map=null, marker=null;
function openOverlay(it){
  overlay.style.display='flex';
  overlayTitle.textContent = `Set Pin â€” ${it.address}`;
  pinLabelEl.value = it.pinLabel || '';
  setTimeout(()=>{
    if (!map){
      map = L.map(bigMapEl).setView([it.pinLat||-45.031, it.pinLng||168.663], it.pinLat?17:13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);
    } else {
      map.setView([it.pinLat||-45.031, it.pinLng||168.663], it.pinLat?17:13);
    }
    if (marker) { map.removeLayer(marker); marker=null; }
    const start = [it.pinLat||it.lat||-45.031, it.pinLng||it.lng||168.663];
    marker = L.marker(start, {draggable:true}).addTo(map);
  }, 30);
  currentPinId = it.id;
}
document.getElementById('cancelPin').addEventListener('click', ()=>{ overlay.style.display='none'; currentPinId=null; });
document.getElementById('useGPS').addEventListener('click', async ()=>{
  if (!navigator.geolocation || !map) return;
  try {
    const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:8000 }));
    const p = [pos.coords.latitude, pos.coords.longitude];
    map.setView(p, 18);
    if (marker) { marker.setLatLng(p); } else { marker = L.marker(p, {draggable:true}).addTo(map); }
  } catch(e){ alert('GPS not available'); }
});
document.getElementById('savePin').addEventListener('click', ()=>{
  if (!currentPinId || !marker) { overlay.style.display='none'; return; }
  const i = state.findIndex(x=>x.id===currentPinId); if (i<0) { overlay.style.display='none'; return; }
  const p = marker.getLatLng();
  state[i].pinLat = p.lat; state[i].pinLng = p.lng; state[i].pinLabel = pinLabelEl.value||''; state[i].updatedAt = now();
  saveLocal(); pushRemote(state[i]).catch(()=>{});
  overlay.style.display='none'; currentPinId=null; render();
});

// Render
function whoLineHTML(show, id, kind, name){
  const text = name ? `(${name})` : '';
  return `<div class="whoLine ${show ? '' : 'empty'}">${show ? `<span class="byname" data-id="${id}" data-kind="${kind}">${text}</span>` : ''}</div>`;
}
function miniMapHTML(it){
  if (!(it.pinLat && it.pinLng)) return '';
  const id = 'mm_'+it.id;
  // drawn after insert via Leaflet to keep perf decent
  setTimeout(()=>{
    const el = document.getElementById(id);
    if (!el || el._drawn) return;
    el._drawn = true;
    const m = L.map(el, {zoomControl:false, attributionControl:false}).setView([it.pinLat,it.pinLng], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(m);
    L.marker([it.pinLat,it.pinLng]).addTo(m).bindPopup(it.pinLabel||it.address);
  },0);
  return `<div id="${id}" class="mini-map"></div>`;
}
function render(){
  listEl.innerHTML='';
  const items = applyFilters(state);
  items.forEach((it)=>{
    const row = document.createElement('div');
    row.className='addr';
    const gasToggle = it.gas==='Yes'
      ? `<div class="toggleWrap">
           <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="gasReplace" ${it.gasReplace?'checked':''}> Gas replace</label>
           ${whoLineHTML(!!(it.gasReplace && it.gasBy), it.id, 'gas', it.gasBy)}
           <div class="hintline" id="hint-gas-${it.id}">â†³ Ticked ${fmtShort(it.gasAt)}</div>
         </div>`
      : '';

    row.innerHTML = `
      <div class="topline">
        <div class="name">${it.address}</div>
        <div class="meta">
          <span class="badge">ðŸ—“ ${it.pickup}</span>
          <button class="icon-btn" title="Remove" data-id="${it.id}" data-act="delete">â€“</button>
        </div>
      </div>
      <div class="actions">
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
          ${whoLineHTML(!!(it.out && it.outBy), it.id, 'out', it.outBy)}
          <div class="hintline" id="hint-out-${it.id}">â†³ Ticked ${fmtShort(it.outAt)}</div>
        </div>
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
          ${whoLineHTML(!!(it.back && it.backBy), it.id, 'back', it.backBy)}
          <div class="hintline" id="hint-back-${it.id}">â†³ Ticked ${fmtShort(it.backAt)}</div>
        </div>
        ${gasToggle}
        <a class="maplink" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address+', Queenstown')}" target="_blank" rel="noopener">Address map</a>
        <button class="btn ghost" data-id="${it.id}" data-act="setpin">${(it.pinLat && it.pinLng) ? 'Edit pin' : 'Set pin'}</button>
      </div>
      ${miniMapHTML(it)}
      <div class="noteRow">
        <textarea class="note" data-id="${it.id}" maxlength="120" placeholder="Notes">${it.note?it.note.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''}</textarea>
      </div>
    `;
    listEl.appendChild(row);
  });
  // auto-resize notes
  document.querySelectorAll('textarea.note').forEach(el=>{
    el.style.height='auto'; const h=Math.min(el.scrollHeight,78); el.style.height=Math.max(30,h)+'px';
  });
  statusEl.textContent='UI ready.';
}

// Interactions
function verifyPasscode(){ const entered = prompt('Enter passcode to confirm delete:'); if (entered!=='5952'){ alert('Incorrect passcode.'); return false; } return true; }

listEl.addEventListener('click', (e)=>{
  const b = e.target.closest('button.btn, button.icon-btn');
  if (b){
    const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
    if (act==='delete'){
      if (confirm('Remove this address?') && verifyPasscode()){
        state = state.filter(x=>x.id!==id);
        saveLocal(); pushRemote({id, _deleted:true, updatedAt:now()}).catch(()=>{});
        render();
      }
      return;
    }
    if (act==='setpin'){ const it=state.find(x=>x.id===id); if(it) openOverlay(it); return; }
  }
  // tap on (Name) â†’ show timestamp; don't toggle
  const s = e.target.closest('.byname'); if(!s) return;
  e.preventDefault(); e.stopPropagation();
  const id = s.getAttribute('data-id'); const kind = s.getAttribute('data-kind');
  const el = document.getElementById(`hint-${kind}-${id}`);
  if (!el) return;
  el.classList.add('show'); clearTimeout(el._t); el._t = setTimeout(()=>el.classList.remove('show'), 4000);
});

// Toggle change
listEl.addEventListener('change', async (e)=>{
  const cb = e.target.closest('input[type=checkbox]'); if(!cb) return;
  const id  = cb.getAttribute('data-id');
  const act = cb.getAttribute('data-act');
  const i = state.findIndex(x=>x.id===id); if (i<0) return;

  if (!userName){
    const v = prompt('Your name (for activity log):', userName || '');
    if (v===null || !v.trim()){ cb.checked = !cb.checked; return; }
    userName = v.trim(); localStorage.setItem(LS_USER, userName);
  }

  state[i][act] = cb.checked;
  const t = now();
  if (act==='out'){ state[i].outBy=userName; state[i].outAt=t; }
  if (act==='back'){ state[i].backBy=userName; state[i].backAt=t; }
  if (act==='gasReplace'){ state[i].gasBy=userName; state[i].gasAt=t; }
  state[i].updatedAt = t;
  saveLocal(); render();
  try { await pushRemote(state[i]); } catch(_){}
});

// Notes save & resize
listEl.addEventListener('input', (e)=>{
  const ta = e.target.closest('textarea.note'); if(!ta) return;
  const id = ta.getAttribute('data-id'); const i = state.findIndex(x=>x.id===id); if (i<0) return;
  state[i].note = ta.value.slice(0,120);
  state[i].updatedAt = now();
  saveLocal(); const h=Math.min(ta.scrollHeight,78); ta.style.height=Math.max(30,h)+'px';
  pushRemote(state[i]).catch(()=>{});
});

// Add address
document.getElementById('addBtn').addEventListener('click', ()=>{
  const addr = prompt('New address:');
  if (!addr || !addr.trim()) return;
  const pickup = prompt('Pickup day (Tuesday/Wednesday/Thursday/Friday):','Tuesday') || 'Tuesday';
  const obj = { id: slug(addr), address: addr.trim(), pickup, gas:'No',
    out:false,outBy:'',outAt:0, back:false,backBy:'',backAt:0, gasReplace:false,gasBy:'',gasAt:0,
    lat:null,lng:null, pinLat:null,pinLng:null,pinLabel:'', note:'', updatedAt: now()
  };
  state.push(obj); saveLocal(); render(); pushRemote(obj).catch(()=>{});
});

// Toolbar: export/import/refresh/optimize
document.getElementById('export').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bin-collab-map.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('file').click());
document.getElementById('file').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = ()=>{
    try{
      const data = JSON.parse(rd.result);
      if (Array.isArray(data)){ state = data; saveLocal(); render(); pushAllRemote().catch(()=>{}); }
      else alert('Invalid file');
    }catch(err){ alert('Could not read file'); }
  };
  rd.readAsText(f); e.target.value='';
});
document.getElementById('refresh').addEventListener('click', async ()=>{ await pullRemote().catch(()=>{}); });
document.getElementById('opt').addEventListener('click', async ()=>{
  // Greedy nearest-neighbour route using pin or lat/lng; keeps all toggles/notes
  const pts = state.map(s=>({ id:s.id, lat:s.pinLat||s.lat, lng:s.pinLng||s.lng }));
  if (!pts.every(p=>p.lat && p.lng)) { statusEl.textContent='Geocodingâ€¦ please wait'; await geocodeAllSequential(); }
  const used = new Set(); const route=[];
  // start from first item for determinism
  let currentIdx = 0;
  for (let k=0;k<pts.length;k++){
    used.add(currentIdx); route.push(pts[currentIdx]);
    let best=-1, bestd=1e12;
    for (let j=0;j<pts.length;j++) if(!used.has(j)){
      const dx=pts[currentIdx].lat-pts[j].lat, dy=pts[currentIdx].lng-pts[j].lng;
      const d=Math.sqrt(dx*dx+dy*dy);
      if (d<bestd){ bestd=d; best=j; }
    }
    if (best===-1) break; currentIdx=best;
  }
  const local = JSON.parse(localStorage.getItem(LS)||'[]');
  state = route.map(r=>{
    const l = local.find(x=>x.id===r.id) || state.find(x=>x.id===r.id);
    return { ...l };
  });
  saveLocal(); render(); statusEl.textContent='Optimized by proximity. Tap again anytime.';
});

// Firebase live sync
let db=null, unsub=null;
(async function initFirebase(){
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    statusEl.textContent='Sync ON â€” live updates enabled.';
    startListener();
    pushAllRemote().catch(()=>{});
  }catch(e){
    statusEl.textContent='Local mode â€” Firebase init failed (check config).';
    logErr(e);
  }
  render(); // always render regardless
})();

function startListener(){
  if(!db) return;
  if (unsub) unsub();
  unsub = db.collection('properties').onSnapshot((snap)=>{
    let changed=false; const remote=[]; snap.forEach(doc=>remote.push(doc.data()));
    for (const r of remote){
      if (r._deleted){ // remote deletion
        const idx = state.findIndex(x=>x.id===r.id);
        if (idx>=0){ state.splice(idx,1); changed=true; }
        continue;
      }
      const i=state.findIndex(x=>x.id===r.id);
      if(i>=0){
        if(!state[i].updatedAt || r.updatedAt>state[i].updatedAt){
          state[i]={...state[i], ...r}; changed=true;
        }
      } else { state.push(r); changed=true; }
    }
    if(changed){ saveLocal(); render(); }
  }, (err)=>{ statusEl.textContent='Listener error â€” check Firestore rules.'; logErr(err); });
}

async function pushRemote(item){ if(!db) return; try{ await db.collection('properties').doc(item.id).set(item, {merge:true}); }catch(e){ logErr(e); throw e; } }
async function pushAllRemote(){ if(!db) return; for (const it of state) await pushRemote(it); }
async function pullRemote(){ if(!db) { render(); return; } const snap=await db.collection('properties').get(); snap.forEach(doc=>{ const r=doc.data(); const i=state.findIndex(x=>x.id===r.id); if(i>=0){ if(!state[i].updatedAt || r.updatedAt>state[i].updatedAt) state[i]=r; } else state.push(r); }); saveLocal(); render(); }
</script>
</body>
</html>
