<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions</title>
<style>
:root{
  --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; --brand:#2563eb;
  --logo:url('Bin_Back_In_Logo.png');
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;min-height:100%}
body::before{
  content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
  background-image: var(--logo); background-repeat:no-repeat; background-position:center; background-size:min(88vmin, 680px);
  opacity:.6; filter:grayscale(0.1);
}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
  padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:5;flex-wrap:wrap}
.brand{font-weight:800;font-size:18px}
.spacer{flex:1}
.btn{padding:12px 16px;border:1px solid var(--border);border-radius:14px;background:var(--card);cursor:pointer;font-weight:700}
.btn.primary{background:var(--brand);color:#fff;border-color:transparent}
.btn.small{padding:8px 12px;font-weight:600;border-radius:12px}
.seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
.seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
.seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
main{max-width:980px;margin:0 auto;padding:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
  background:var(--card);padding:10px 14px;border-radius:14px;min-width:180px}
.search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
.addr{display:grid;gap:10px;border:1px solid var(--border);border-radius:16px;padding:14px 12px;margin-bottom:12px;background:var(--card);position:relative;box-shadow:0 1px 0 rgba(0,0,0,.02)}
.topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.name{font-weight:900;letter-spacing:.2px}
.meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
.actions{display:flex;gap:12px 14px;align-items:flex-start;flex-wrap:wrap}
.toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:10px 12px}
.icon-btn{border:1px solid var(--border);background:var(--card);font-size:18px;line-height:1;min-width:30px;min-height:28px;
  padding:2px 8px;border-radius:10px;color:var(--muted);cursor:pointer;touch-action:manipulation}
.maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
.note{width:100%;font-size:16px;line-height:1.4;padding:10px 12px;border:1px solid var(--border);border-radius:12px;resize:none;overflow:hidden;height:38px;min-height:38px;max-height:92px;background:transparent}
.note::placeholder{color:var(--muted);opacity:.75}
.toggleWrap{display:flex;flex-direction:column;align-items:flex-start;gap:6px;min-height:72px}
.statusline{height:22px;line-height:22px;font-size:13px;color:var(--muted)}
.statusline .label{font-weight:700;color:var(--ink)}
.statusline .who{font-weight:700}
.statusline .time{opacity:.9}
.banner{display:flex;gap:8px;align-items:center;border:1px dashed var(--border);background:#fff7; padding:10px 14px;border-radius:12px;font-size:12px}
select.areaSel{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:10px 12px}

body.gated main, body.gated header .app-only{display:none !important}
#gate{display:block;max-width:720px;margin:24px auto;padding:0 12px}
.gstack{display:grid;gap:14px}
.gcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px 16px 18px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
.gtitle{font-size:22px;font-weight:900;margin:0 0 6px}
.gsub{color:var(--muted);margin:0 0 10px}
.row{display:flex;gap:8px;align-items:center}
.row .field{flex:1}
.field{display:flex;gap:8px;align-items:center}
.field input, .field select{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;background:transparent;color:var(--ink)}

.bbi-photo-wrap{margin-top:8px}
.bbi-photo-row{display:flex;align-items:center;gap:12px;flex-wrap:nowrap}
.bbi-thumb{display:block;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#f3f4f6;cursor:pointer;width:120px;height:120px;position:relative}
.bbi-thumb::after{content:'No photo'; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:12px}
.bbi-thumb.hasimg::after{content:''}
.bbi-thumb img{display:block;width:100%;height:100%;object-fit:cover}
.bbi-photo-cap{margin-top:6px;color:#6b7280;font-size:12px}
.bbi-photo-tools{display:flex;gap:8px;align-items:center}
.bbi-photo-tools .file-btn{border:1px solid var(--border);border-radius:12px;padding:8px 12px;background:var(--card);cursor:pointer}
.bbi-photo-tools input[type=file]{display:none}
</style>
</head>
<body class="gated">
<header>
  <div class="brand">Bin Back In Solutions</div><div id="who" style="margin-left:6px;color:#6b7280;font-weight:600" class="app-only"></div>
  <div class="spacer"></div>
  <div class="seg app-only" id="daySeg">
    <button data-day="All" class="active">All</button>
    <button data-day="Tuesday">Tue</button>
    <button data-day="Wednesday">Wed</button>
    <button data-day="Thursday">Thu</button>
    <button data-day="Friday">Fri</button>
  </div>
  <button id="addBtn" class="btn app-only" type="button">+ Address</button>
</header>

<section id="gate">
  <div class="gstack">
    <article class="gcard">
      <h2 class="gtitle">Business</h2>
      <p class="gsub">Manage an area</p>
      <div class="row"><div class="field" style="flex:1.1"><input id="binName" placeholder="Your name" autocomplete="name" /></div></div>
      <div class="row"><div class="field" style="flex:1.1"><input id="binPass" placeholder="Business code" inputmode="numeric" maxlength="12" /></div></div>
      <div class="row" style="margin-top:8px">
        <div class="field"><select id="binOpenArea" class="areaSel"></select></div>
        <div class="field"><input id="binAreaCode" placeholder="Area code" inputmode="numeric" maxlength="12" /></div>
        <button id="binOpenBtn" class="btn primary" type="button">Open</button>
      </div>
    </article>
    <article class="gcard">
      <h2 class="gtitle">Property Manager</h2>
      <p class="gsub">Work inside your area</p>
      <div class="row"><div class="field" style="flex:1.1"><input id="pmName" placeholder="Your name" autocomplete="name" /></div></div>
      <div class="row">
        <div class="field"><select id="pmArea" class="areaSel"></select></div>
        <div class="field"><input id="pmCode" placeholder="Area code" inputmode="numeric" maxlength="12" /></div>
        <button id="pmOpen" class="btn" type="button">Enter</button>
      </div>
    </article>
  </div>
</section>

<main>
  <div class="toolbar app-only">
    <div class="search"><span>🔎</span><input id="search" placeholder="Search address…" /></div>
    <button id="refresh" class="btn" type="button">Refresh</button>
    <button id="optimiseOut" class="btn small" type="button">Optimise Out</button>
    <button id="optimiseBack" class="btn small" type="button">Optimise Back</button>
    <button id="exportBtn" class="btn small" type="button">Export area</button>
    <button id="seedQtn" class="btn small" type="button" style="display:none">Seed Queenstown</button>
    <input id="importFile" type="file" accept=".csv,.json,text/csv,application/json" style="display:none">
  </div>
  <div id="status" class="banner">Booting…</div>
  <h2 style="margin:10px 0 12px 0;"><span id="areaTitle">Area</span> — Addresses</h2>
  <div id="list"></div>
</main>

<!-- Edit Address Modal -->
<div id="editModal" style="display:none; position:fixed; inset:0; background:#0008; z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; color:#111; max-width:560px; width:92%; border-radius:12px; padding:16px; border:1px solid #e5e7eb;">
    <h3 style="margin:0 0 8px 0;">Edit address</h3>
    <div style="display:grid; gap:10px;">
      <label style="display:grid; gap:6px;">
        <span style="color:#6b7280;">Address</span>
        <input id="edAddress" style="padding:10px; border:1px solid #e5e7eb; border-radius:10px;" />
      </label>
      <label style="display:grid; gap:6px;">
        <span style="color:#6b7280;">Pickup day</span>
        <select id="edPickup" style="padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
          <option>Tuesday</option>
          <option>Wednesday</option>
          <option>Thursday</option>
          <option>Friday</option>
        </select>
      </label>
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="edGas" type="checkbox" />
        <span style="color:#111;">Has gas</span>
      </label>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; justify-content:space-between;">
      <div style="display:flex; gap:8px;">
        <button id="edCancel" class="btn" type="button">Cancel</button>
        <button id="edSave" class="btn primary" type="button">Save</button>
      </div>
      <button id="edDelete" class="btn" type="button" style="background:#fee2e2;border-color:#fecaca;">Delete</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, addDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import * as ST from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAaDT6hFD38_P1AhQMF_vT18tXG9_pp8Sw",
  authDomain: "binbackinsolutions.firebaseapp.com",
  projectId: "binbackinsolutions",
  storageBucket: "binbackinsolutions.firebasestorage.app",
  messagingSenderId: "740345071529",
  appId: "1:740345071529:web:e960f05ba0c982194126b8",
  measurementId: "G-6XK5H9LWWK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let CURRENT_USER = (localStorage.getItem('bbi_user_name')||'').trim();
function setCurrentUser(name){
  CURRENT_USER = (name||'').trim() || 'User';
  localStorage.setItem('bbi_user_name', CURRENT_USER);
}


// Admin / login
let IS_ADMIN=false;
let LOCKED_AREA="";
let unsub=null;

// UI helpers
const $=s=>document.querySelector(s);
const statusEl=$("#status"); function setBanner(t){ statusEl.textContent=t; }
function fmtShort(ts){ if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})+' · '+d.toLocaleDateString([], {weekday:'short'})+' '+d.toLocaleDateString([], {day:'2-digit',month:'short'}); }

let ADDRS=[];
let AREAS = JSON.parse(localStorage.getItem('bbi_areas_v1')||'[]');

// Guarantee defaults
if(!Array.isArray(AREAS) || AREAS.length===0){
  AREAS=["Queenstown","Tikipunga Retirement"];
  localStorage.setItem('bbi_areas_v1', JSON.stringify(AREAS));
}

function hydrateAreas(){
  const fill=(sel)=>{ sel.innerHTML=''; AREAS.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; sel.appendChild(o); }); };
  fill($("#pmArea")); fill($("#binOpenArea"));
}
(async ()=>{ setBanner("Signing in…"); await signInAnonymously(auth); setBanner("Connected"); hydrateAreas();
  // prefill name fields
  const n = CURRENT_USER; if(n){ const bn=document.getElementById('binName'); if(bn) bn.value=n; const pn=document.getElementById('pmName'); if(pn) pn.value=n; }
})();

// Gate verification
const MASTER_BIN='9999';
const DEFAULT_CODE='0000';
const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

async function sha256Hex(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function verifyAreaCode(areaName, code){
  if(!code) return false;
  const d=await getDoc(doc(db,'areas', slug(areaName)));
  if(!d.exists()) return code===DEFAULT_CODE;
  return (d.data().passHash === await sha256Hex(code));
}

$("#pmOpen").addEventListener('click', async ()=>{
  const area=$("#pmArea").value; const code=($("#pmCode").value||'').trim();
  if(!(await verifyAreaCode(area, code))) return alert('Incorrect code');
  setCurrentUser(document.getElementById('pmName')?.value);
  IS_ADMIN=false; LOCKED_AREA=area; openArea();
});
$("#binOpenBtn").addEventListener('click', async ()=>{
  const pass=($("#binPass").value||'').trim(); if(pass!==MASTER_BIN) return alert('Incorrect code');
  const area=$("#binOpenArea").value; const code=($("#binAreaCode").value||'').trim();
  if(!(await verifyAreaCode(area, code))) return alert('Incorrect area code');
  setCurrentUser(document.getElementById('binName')?.value);
  IS_ADMIN=true; LOCKED_AREA=area; openArea();
});

// Toolbar
let filterText='', filterDay='All';
document.getElementById('daySeg').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return; document.querySelectorAll('#daySeg button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); filterDay=b.getAttribute('data-day'); render();
});
document.getElementById('search').addEventListener('input', e=>{ filterText=e.target.value.toLowerCase(); render(); });
document.getElementById('refresh').addEventListener('click', ()=>{ if(LOCKED_AREA) subscribeArea(LOCKED_AREA, true); });



// Export
function toCSV(rows){
  const esc=s=>`"${String(s||'').replace(/"/g,'""')}"`;
  return 'address,area,pickup\\n' + rows.map(r=>[esc(r.address),esc(r.area),esc(r.pickup||'')].join(',')).join('\\n') + '\\n';
}
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const area=LOCKED_AREA; const rows=ADDRS.filter(a=>String(a.area||'').trim().toLowerCase()===area.toLowerCase())
    .map(a=>({address:a.address, area:a.area, pickup:a.pickup||'Tuesday'}));
  const blob=new Blob([toCSV(rows)],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=(area||'area')+'_addresses.csv'; a.click(); URL.revokeObjectURL(url);
});

// List rendering
function statusLine(label, who, when){ return (who && when) ? `<span class="label">${label}</span> — <span class="who">${who}</span> — <span class="time">${fmtShort(when)}</span>` : '&nbsp;'; }
function applyFilters(arr){
  return arr.filter(it=>{
    const dayOK=(filterDay==='All'||it.pickup===filterDay);
    const txtOK=(!filterText||it.address?.toLowerCase().includes(filterText));
    const area=String(it.area||'').trim();
    const areaOK=(area.toLowerCase()===LOCKED_AREA.toLowerCase());
    return dayOK&&txtOK&&areaOK;
  });
}
function openInMaps(query){ if(!query) return; const encoded=encodeURIComponent(String(query).trim()); const isIOS=/iPad|iPhone|iPod/i.test(navigator.userAgent); const url=isIOS?`maps://?q=${encoded}`:`https://www.google.com/maps/search/?api=1&query=${encoded}`; const w=window.open(url,'_blank','noopener'); if(!w) window.location.href=url; }

function render(){
  $("#areaTitle").textContent=LOCKED_AREA||'Area';
  const listEl=$("#list"); listEl.innerHTML='';
  const sorted=ADDRS.slice().sort((a,b)=>{
    const ra=(typeof a.rank==='number')?a.rank:1e9; const rb=(typeof b.rank==='number')?b.rank:1e9;
    if(ra!==rb) return ra-rb; return (a.address||'').localeCompare(b.address||'');
  });
  for(const it of applyFilters(sorted)){
    const area=String(it.area||LOCKED_AREA).trim();
    const row=document.createElement('div'); row.className='addr'; row.dataset.id=it.id;
    const outL = statusLine('Out', it.outBy, it.outAt);
    const backL = statusLine('Back', it.backBy, it.backAt);
    const q = `${it.address||''}, ${area}`;
    row.innerHTML=`
      <div class="topline">
        <div class="name">${it.address||''}</div>
        <div class="meta">
          <span class="badge">📍 ${area}</span>
          <span class="badge">🗓 ${it.pickup||''}</span>${it.gas?` <span class="badge">⛽ Gas</span>`:""}
          <button class="icon-btn edit app-only" type="button" data-act="edit" data-id="${it.id}" aria-label="Edit address" title="Edit">✎</button>
        </div>
      </div>
      <div class="actions">
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
          <div class="statusline" id="stat-out-${it.id}">${outL}</div>
        </div>
        <div class="toggleWrap">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
          <div class="statusline" id="stat-back-${it.id}">${backL}</div>
        </div>
        <a class="maplink" href="javascript:void(0)" data-q="${q}" data-act="map">Address map</a>
      </div>
      <div class="bbi-photo-wrap" data-id="${it.id}">
        <div class="bbi-photo-row">
          <div class="bbi-thumb"><img alt="Photo"></div>
          <div class="bbi-photo-tools">
            <button class="file-btn" data-id="${it.id}">Add/Replace Photo</button>
            <input type="file" accept="image/*" capture="environment" data-id="${it.id}">
          </div>
        </div>
        <div class="bbi-photo-cap"></div>
      </div>
      <textarea class="note app-only" data-id="${it.id}" maxlength="120" placeholder="Notes"
        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false" inputmode="text"></textarea>
    `;
    const ta=row.querySelector('textarea.note'); if(ta) ta.value=it.note?String(it.note):"";
    listEl.appendChild(row);
  }
  document.querySelectorAll('textarea.note').forEach(el=>{ el.style.height='auto'; const h=Math.min(el.scrollHeight,92); el.style.height=Math.max(38,h)+'px'; });
  document.querySelectorAll('.bbi-photo-wrap').forEach(wrap=> activatePhoto(wrap));
}

// Subscribe area
function subscribeArea(areaName, force=false){
  if(unsub){ unsub(); unsub=null; }
  const qy = query(collection(db,'addresses'), where('area','==',areaName));
  unsub = onSnapshot(qy, (snap)=>{ ADDRS=snap.docs.map(d=>({id:d.id, ...d.data()})); render(); setBanner('Live — synced'); });
  if(force) setBanner('Refreshed');
}
function openArea(){
  document.getElementById('gate').style.display='none';
  document.body.classList.remove('gated');
  subscribeArea(LOCKED_AREA);
  maybeShowSeedButton();
  const whoEl=document.getElementById('who'); if(whoEl) whoEl.textContent = CURRENT_USER ? `· ${CURRENT_USER}` : '';
}

// Interactions
document.getElementById('list').addEventListener('change', async (e)=>{
  const cb=e.target.closest('input[type=checkbox]'); if(!cb) return;
  const id=cb.getAttribute('data-id'), act=cb.getAttribute('data-act'); const t=Date.now(); const who=CURRENT_USER || 'User';
  const patch={ updatedAt:t };
  if(act==='out'){ patch.out=cb.checked; patch.outBy=cb.checked?who:""; patch.outAt=cb.checked?t:0; }
  if(act==='back'){ patch.back=cb.checked; patch.backBy=cb.checked?who:""; patch.backAt=cb.checked?t:0; }
  try{ await updateDoc(doc(db,'addresses',id), patch); }catch(err){ alert('Update failed'); }
});
const SAVE_T=new Map();
document.getElementById('list').addEventListener('input', (e)=>{
  const ta=e.target.closest('textarea.note'); if(!ta) return;
  const id=ta.getAttribute('data-id'); const v=ta.value.slice(0,120);
  ta.style.height='auto'; ta.style.height=Math.max(38, Math.min(ta.scrollHeight,92))+'px';
  if(SAVE_T.has(id)) clearTimeout(SAVE_T.get(id));
  SAVE_T.set(id, setTimeout(async ()=>{ try{ await updateDoc(doc(db,'addresses',id), { note:v, updatedAt:Date.now(), noteBy: CURRENT_USER || 'User' }); }catch(e){} SAVE_T.delete(id); }, 800));
}, true);
document.getElementById('list').addEventListener('click', (e)=>{
  const a=e.target.closest('[data-act="map"]'); if(a){ e.preventDefault(); openInMaps(a.getAttribute('data-q')); return; }
  const up=e.target.closest('.file-btn'); if(up){ const wrap=up.closest('.bbi-photo-wrap'); const inp=wrap.querySelector('input[type=file]'); inp.click(); return; }
}, {passive:false});

// Add address in locked area
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const area=LOCKED_AREA;
  const address=(prompt('Street address:')||'').trim(); if(!address) return;
  const pickup=prompt('Pickup day (Tuesday/Wednesday/Thursday/Friday):','Tuesday')||'Tuesday';
  try{ await addDoc(collection(db,'addresses'), { address, area, pickup, out:false, back:false, gas:false, note:'', updatedAt:Date.now() }); }catch(e){ alert('Add failed'); }
});

// Photo helper
function ensureLightbox(){ if(document.getElementById('bbi-lightbox')) return; const box=document.createElement('div'); box.id='bbi-lightbox'; box.style.cssText='position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000c;z-index:9999;'; const inner=document.createElement('img'); inner.style.cssText='max-width:96vw;max-height:92vh;display:block;border-radius:8px;'; box.appendChild(inner); box.addEventListener('click', ()=>{ box.style.display='none'; document.documentElement.style.overflow=''; }); document.body.appendChild(box); }
function openLightbox(src){ ensureLightbox(); const box=document.getElementById('bbi-lightbox'); const img=box.querySelector('img'); img.src=src; document.documentElement.style.overflow='hidden'; box.style.display='flex'; }


function activatePhoto(wrap){
  if(wrap.__active) return; wrap.__active=true;
  const id=wrap.getAttribute('data-id');
  const img=wrap.querySelector('img'); const thumb=wrap.querySelector('.bbi-thumb'); const cap=wrap.querySelector('.bbi-photo-cap'); const inp=wrap.querySelector('input[type=file]');

  // helper: mark thumb when image present
  function markHasImg() {
    if(img && img.src) { thumb.classList.add('hasimg'); } else { thumb.classList.remove('hasimg'); }
  }

  // Try to load existing cloud photo; if missing, placeholder remains
  (async ()=>{
    try{
      const storage=ST.getStorage(app);
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      img.src=url+'#'+Date.now();
      markHasImg();
      cap.textContent = '';
    }catch(_){
      cap.textContent = '';
      markHasImg();
    }
  })();

  // Tap to fullscreen
  thumb.addEventListener('click', async ()=>{
    if(!img.src){ return; }
    try{
      const storage=ST.getStorage(app);
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      openLightbox(url+'#'+Date.now());
    }catch(_){
      openLightbox(img.src);
    }
  });

  // Upload handler with immediate local preview & persistence
  inp.addEventListener('change', async ()=>{
    const f=inp.files && inp.files[0]; if(!f) return;

    // Immediate local preview
    try{
      const reader=new FileReader();
      reader.onload=()=>{
        img.src=reader.result;
        markHasImg();
        cap.textContent='Uploading…';
      };
      reader.readAsDataURL(f);
    }catch(_){ /* ignore */ }

    // Upload to Storage
    try{
      const storage=ST.getStorage(app);
      await ST.uploadBytes(ST.ref(storage, `addresses/${id}/latest.jpg`), f, {contentType:f.type||'image/jpeg', cacheControl:'no-cache'});
      await updateDoc(doc(db,'addresses',id), { photoBy: CURRENT_USER || 'User', photoAt: Date.now() });
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      img.src=url+'#'+Date.now();
      markHasImg();
      cap.textContent = `Last updated by ${CURRENT_USER||'User'} at ${fmtShort(Date.now())}`;
    }catch(err){
      cap.textContent = 'Upload failed — tap button to retry. Preview saved locally.';
    }finally{
      inp.value='';
    }
  });
}

  if(wrap.__active) return; wrap.__active=true;
  const id=wrap.getAttribute('data-id');
  const img=wrap.querySelector('img'); const thumb=wrap.querySelector('.bbi-thumb'); const cap=wrap.querySelector('.bbi-photo-cap'); const inp=wrap.querySelector('input[type=file]');

  // Try to load existing cloud photo; if missing, keep thumb hidden until user uploads.
  (async ()=>{
    try{
      const storage=ST.getStorage(app);
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      img.src=url+'#'+Date.now();
      thumb.style.display='block';
      cap.textContent = '';
    }catch(_){
      // no existing cloud photo
      thumb.style.display='none';
      cap.textContent = '';
    }
  })();

  // Tap to fullscreen
  thumb.addEventListener('click', async ()=>{
    if(!img.src) return;
    try{
      const storage=ST.getStorage(app);
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      openLightbox(url+'#'+Date.now());
    }catch(_){
      openLightbox(img.src);
    }
  });

  // Upload handler with immediate local preview & persistence
  inp.addEventListener('change', async ()=>{
    const f=inp.files && inp.files[0]; if(!f) return;

    // 2a) Immediate local preview
    try{
      const reader=new FileReader();
      reader.onload=()=>{
        img.src=reader.result;
        thumb.style.display='block';
        cap.textContent='Uploading…';
      };
      reader.readAsDataURL(f);
    }catch(_){ /* ignore preview errors */ }

    // 2b) Upload to Storage; keep the thumb even if upload fails.
    try{
      const storage=ST.getStorage(app);
      await ST.uploadBytes(ST.ref(storage, `addresses/${id}/latest.jpg`), f, {contentType:f.type||'image/jpeg', cacheControl:'no-cache'});
      await updateDoc(doc(db,'addresses',id), { photoBy: CURRENT_USER || 'User', photoAt: Date.now() });
      const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`));
      img.src=url+'#'+Date.now();
      cap.textContent = `Last updated by ${CURRENT_USER||'User'} at ${fmtShort(Date.now())}`;
    }catch(err){
      // keep the local preview; let user know they can retry
      cap.textContent = 'Upload failed — tap button to retry. Preview saved locally.';
    }finally{
      inp.value='';
    }
  });
}

  if(wrap.__active) return; wrap.__active=true;
  const id=wrap.getAttribute('data-id'); const img=wrap.querySelector('img'); const thumb=wrap.querySelector('.bbi-thumb'); const cap=wrap.querySelector('.bbi-photo-cap'); const inp=wrap.querySelector('input[type=file]');
  (async ()=>{ try{ const storage=ST.getStorage(app); const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`)); img.src=url+'#'+Date.now(); thumb.style.display='block'; }catch(_){ thumb.style.display='none'; } })();
  (async ()=>{ try{ const d=await getDoc(doc(db,'addresses',id)); if(d.exists()){ const v=d.data(); cap.textContent=(v.photoBy&&v.photoAt)?`Last updated by ${v.photoBy} at ${fmtShort(v.photoAt)}`:''; } }catch(_){ cap.textContent=''; } })();
  thumb.addEventListener('click', async ()=>{ if(!img.src) return; try{ const storage=ST.getStorage(app); const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`)); openLightbox(url+'#'+Date.now()); }catch(_){ openLightbox(img.src); } });
  inp.addEventListener('change', async ()=>{ const f=inp.files&&inp.files[0]; if(!f) return;
    try{ const storage=ST.getStorage(app); await ST.uploadBytes(ST.ref(storage, `addresses/${id}/latest.jpg`), f, {contentType:f.type||'image/jpeg', cacheControl:'no-cache'}); await updateDoc(doc(db,'addresses',id), { photoBy: CURRENT_USER || 'User', photoAt:Date.now() }); const url=await ST.getDownloadURL(ST.ref(storage, `addresses/${id}/latest.jpg`)); img.src=url+'#'+Date.now(); thumb.style.display='block'; }catch(err){ alert('Upload failed'); } finally{ inp.value=''; }
  });
}

// Edit modal
let EDIT_ID=null;
const mEdit=document.getElementById('editModal'); const edAddress=document.getElementById('edAddress'); const edPickup=document.getElementById('edPickup'); const edGas=document.getElementById('edGas');
document.getElementById('edCancel').addEventListener('click', ()=>{ mEdit.style.display='none'; EDIT_ID=null; });
document.getElementById('edDelete').addEventListener('click', async ()=>{ if(!EDIT_ID) return; if(!confirm('Delete this address?')) return; try{ await deleteDoc(doc(db,'addresses', EDIT_ID)); }catch(e){ alert('Delete failed'); } mEdit.style.display='none'; EDIT_ID=null; });
document.getElementById('edSave').addEventListener('click', async ()=>{ if(!EDIT_ID) return; const addr=(edAddress.value||'').trim(); const pickup=edPickup.value||'Tuesday'; const gas=!!edGas.checked; if(!addr){ alert('Address required'); return; } try{ await updateDoc(doc(db,'addresses', EDIT_ID), { address:addr, pickup, gas, updatedAt:Date.now(), editedBy: CURRENT_USER || 'User' }); }catch(e){ alert('Save failed'); } mEdit.style.display='none'; EDIT_ID=null; });
document.getElementById('list').addEventListener('click', async (e)=>{
  const btn=e.target.closest('[data-act="edit"]'); if(btn){ EDIT_ID=btn.getAttribute('data-id'); try{ const d=await getDoc(doc(db,'addresses', EDIT_ID)); if(d.exists()){ const v=d.data(); edAddress.value=v.address||''; edPickup.value=v.pickup||'Tuesday'; edGas.checked=!!v.gas; } }catch(_){ edAddress.value=''; edPickup.value='Tuesday'; edGas.checked=false; } mEdit.style.display='flex'; return; }
}, {capture:false});

// --- One-time seeder for Queenstown (admin only) ---
const SEED_KEY='seed_qtn_done_v1';
const SEED_LIST=[
  {address:'30 Woodlands Close', pickup:'Tuesday'},
  {address:'6 Goldrush Way', pickup:'Tuesday'},
  {address:'20 Goldleaf', pickup:'Tuesday'},
  {address:'2/64 Marina Drive', pickup:'Tuesday'},
  {address:'1/47 Lomond Cres', pickup:'Wednesday'},
  {address:'2/11 Gum Lane', pickup:'Wednesday'},
  {address:'22c Malaghan Street', pickup:'Wednesday'},
  {address:'78 Highview', pickup:'Wednesday'},
  {address:'70 Panorama Terrace', pickup:'Wednesday'},
  {address:'7 Peregrine Place', pickup:'Wednesday'},
  {address:'101 Hensman Road', pickup:'Wednesday'},
  {address:'18 Amber Close', pickup:'Thursday'},
  {address:'6 Redfern Terrace', pickup:'Thursday'},
  {address:'14 Cumberland Road', pickup:'Thursday'},
  {address:'12 Corriedale Road', pickup:'Friday'},
  {address:'42 Muster Road', pickup:'Friday'}
];
function maybeShowSeedButton(){
  const btn=$("#seedQtn"); const already=localStorage.getItem(SEED_KEY)==='done';
  if(IS_ADMIN && LOCKED_AREA.toLowerCase()==='queenstown' && !already){ btn.style.display='inline-block'; } else { btn.style.display='none'; }
}
document.getElementById('seedQtn').addEventListener('click', async ()=>{
  if(!(IS_ADMIN && LOCKED_AREA.toLowerCase()==='queenstown')) return;
  if(!confirm('Add the preset Queenstown addresses now? Duplicates will be skipped.')) return;
  const existing=new Set(ADDRS.filter(a=>String(a.area||'').trim().toLowerCase()==='queenstown').map(a=>String(a.address||'').trim().toLowerCase()));
  let ok=0, skip=0, fail=0;
  for(const r of SEED_LIST){
    const key=String(r.address||'').trim().toLowerCase(); if(!key) continue;
    if(existing.has(key)){ skip++; continue; }
    try{ await addDoc(collection(db,'addresses'), { address:r.address, area:'Queenstown', pickup:r.pickup, out:false, back:false, gas:false, note:'', updatedAt:Date.now() }); ok++; existing.add(key); }catch(e){ fail++; }
  }
  localStorage.setItem(SEED_KEY,'done'); maybeShowSeedButton();
  alert(`Seed complete. Added: ${ok}${skip?`, skipped: ${skip}`:''}${fail?`, failed: ${fail}`:''}`);
});

// --- Optimise logic: write rank for current area ---
async function optimiseOut(){
  const area = LOCKED_AREA;
  const items = ADDRS.filter(a => (String(a.area||'').trim().toLowerCase()===area.toLowerCase()));
  // out false first, then address alpha
  const sorted = items.slice().sort((a,b)=>{
    const oa = a.out?1:0, ob = b.out?1:0;
    if(oa!==ob) return oa-ob;
    return String(a.address||'').localeCompare(String(b.address||''));
  });
  let i=1;
  for(const it of sorted){
    try{ await updateDoc(doc(db,'addresses', it.id), { rank:i++, updatedAt:Date.now() }); }catch(_){}
  }
  alert('Optimised for taking OUT (unchecked first).');
}
async function optimiseBack(){
  const area = LOCKED_AREA;
  const items = ADDRS.filter(a => (String(a.area||'').trim().toLowerCase()===area.toLowerCase()));
  // back false first, but only among ones marked out=true; then address alpha
  const sorted = items.slice().sort((a,b)=>{
    const ea = (a.out?0:1);  // prefer ones that are already out
    const eb = (b.out?0:1);
    if(ea!==eb) return ea-eb;
    const ba = a.back?1:0, bb = b.back?1:0;
    if(ba!==bb) return ba-bb;
    return String(a.address||'').localeCompare(String(b.address||''));
  });
  let i=1;
  for(const it of sorted){
    try{ await updateDoc(doc(db,'addresses', it.id), { rank:i++, updatedAt:Date.now() }); }catch(_){}
  }
  alert('Optimised for bringing BACK (Out first, then unchecked Back).');
}
document.getElementById('optimiseOut').onclick = optimiseOut;
document.getElementById('optimiseBack').onclick = optimiseBack;

</script>
</body>
</html>
