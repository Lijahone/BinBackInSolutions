
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Back In Solutions</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  :root{
    --bg:#f7f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --brand:#2563eb; --brand-ink:#fff; --ok:#16a34a; --warn:#ea580c;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --card:#0f1529; --ink:#e5e7eb; --muted:#9aa1b2; --border:#2a3352; --brand:#3b82f6; }
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);
    padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:10;flex-wrap:wrap}
  .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
  .spacer{flex:1}
  .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);
    cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);color:var(--brand-ink);border-color:transparent}
  .btn.ghost{background:transparent}
  .seg{display:flex;gap:6px;background:var(--bg);padding:4px;border-radius:12px;border:1px solid var(--border)}
  .seg button{padding:8px 12px;border:0;border-radius:10px;background:transparent;font-weight:600;color:var(--muted)}
  .seg button.active{background:var(--card);color:var(--ink);border:1px solid var(--border)}
  main{max-width:900px;margin:0 auto;padding:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .search{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--border);
    background:var(--card);padding:8px 12px;border-radius:12px}
  .search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%;font-size:16px}
  .section{background:transparent;padding:0;margin-bottom:12px}
  .addr{display:grid;grid-template-columns:1fr;gap:10px;border:1px solid var(--border);
    border-radius:16px;padding:14px 12px;margin-bottom:10px;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .topline{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .name{font-weight:800;letter-spacing:.2px}
  .meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
  .badge.warn{border-color:rgba(234,88,12,.25); background:rgba(234,88,12,.08)}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .toggle input{width:20px;height:20px}
  .maplink{border:1px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none}
  .mini-map{height:180px;border:1px solid var(--border);border-radius:12px;margin-top:4px;width:100%}
  #status{font-size:12px;color:var(--muted)}
  #debug{font-size:12px;color:#b91c1c;white-space:pre-wrap;background:#fff1f2;border:1px solid #fecdd3;border-radius:10px;padding:8px;margin-top:8px;display:none}
</style>
</head>
<body>
<header>
  <div class="brand">Bin Back In Solutions</div>
  <div class="spacer"></div>
  <div class="seg" id="daySeg">
    <button data-day="All" class="active">All</button>
    <button data-day="Tuesday">Tue</button>
    <button data-day="Wednesday">Wed</button>
    <button data-day="Thursday">Thu</button>
    <button data-day="Friday">Fri</button>
  </div>
  <button id="addBtn" class="btn">+ Address</button>
  <button id="userBtn" class="btn">User</button>
</header>

<main>
  <div class="toolbar">
    <div class="search">
      <span>ðŸ”Ž</span>
      <input id="search" placeholder="Search addressâ€¦" />
    </div>
    <button id="refresh" class="btn ghost">Refresh</button>
    <button id="opt" class="btn ghost">Optimize</button>
    <button id="export" class="btn ghost">Export</button>
    <input id="file" type="file" accept=".json" style="display:none">
    <button id="importBtn" class="btn ghost">Import</button>
  </div>

  <div class="section">
    <div id="status">Connectingâ€¦</div>
    <div id="debug"></div>
  </div>

  <div class="section">
    <h2 style="margin:6px 0 12px 0;">Queenstown â€” Addresses</h2>
    <div id="list"></div>
  </div>
</main>

<!-- Fullscreen Map Overlay -->
<div id="overlay" class="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50">
  <div class="panel" style="width:min(700px,95vw);height:min(70vh,520px);background:#fff;border-radius:12px;display:flex;flex-direction:column;overflow:hidden">
    <header style="display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border);padding:10px 12px">
      <div id="overlayTitle" class="brand" style="font-size:16px">Set Pin</div>
      <div class="spacer"></div>
      <button id="cancelPin" class="btn">Cancel</button>
      <button id="savePin" class="btn primary">Save</button>
    </header>
    <div id="bigMap" style="flex:1"></div>
    <div style="padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center">
      <label>Label:</label><input id="pinLabel" placeholder="e.g., by mailbox" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px">
      <button id="useGPS" class="btn">Use GPS</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAaDT6hFD38_P1AhQMF_vT18tXG9_pp8Sw",
    authDomain: "binbackinsolutions.firebaseapp.com",
    projectId: "binbackinsolutions",
    storageBucket: "binbackinsolutions.appspot.com",
    messagingSenderId: "740345071529",
    appId: "1:740345071529:web:e960f05ba0c982194126b8",
    measurementId: "G-6XK5H9LWWK"
  };

  const SEED = [
    {"address":"30 Woodlands Close", "pickup":"Tuesday", "gas":"No"},
    {"address":"6 Goldrush Way", "pickup":"Tuesday", "gas":"Yes"},
    {"address":"20 Goldleaf", "pickup":"Tuesday", "gas":"Yes"},
    {"address":"2/64 Marina Drive", "pickup":"Tuesday", "gas":"Yes"},
    {"address":"34a Brisbane Street", "pickup":"Tuesday", "gas":"No"},
    {"address":"1/47 Lomond Cres", "pickup":"Wednesday", "gas":"No"},
    {"address":"39 Lomond Cres", "pickup":"Wednesday", "gas":"No"},
    {"address":"41 Lomond Cres", "pickup":"Wednesday", "gas":"No"},
    {"address":"2/11 Gum Lane", "pickup":"Wednesday", "gas":"No"},
    {"address":"22C Malaghan Street", "pickup":"Wednesday", "gas":"No"},
    {"address":"78 Highview", "pickup":"Wednesday", "gas":"No"},
    {"address":"70 Panorama Terrace", "pickup":"Wednesday", "gas":"No"},
    {"address":"7 Peregrine Place", "pickup":"Wednesday", "gas":"No"},
    {"address":"101 Hensman Road", "pickup":"Wednesday", "gas":"Yes"},
    {"address":"18 Amber Close", "pickup":"Thursday", "gas":"Yes"},
    {"address":"6 Redfern Terrace", "pickup":"Thursday", "gas":"Yes"},
    {"address":"14 Cumberland Road", "pickup":"Thursday", "gas":"No"},
    {"address":"12 Corriedale Road", "pickup":"Friday", "gas":"No"},
    {"address":"42 Muster Road", "pickup":"Friday", "gas":"Yes"}
  ];

  const $ = s => document.querySelector(s);
  const listEl = $('#list');
  const statusEl = $('#status');
  const debugEl = $('#debug');
  const overlay = $('#overlay');
  const overlayTitle = $('#overlayTitle');
  const bigMapEl = $('#bigMap');
  const pinLabelEl = $('#pinLabel');
  const LS = 'bbi_collab_map_simplified_v1';
  const LS_USER = 'bbi_user_name';

  let userName = localStorage.getItem(LS_USER) || '';
  function logErr(e){ debugEl.style.display='block'; debugEl.textContent = 'Error: ' + (e && e.message ? e.message : e); }
  function askUser(){ const v = prompt('Your name (for activity log):', userName || ''); if (v!==null){ userName = v.trim(); localStorage.setItem(LS_USER, userName); render(); } }
  document.getElementById('userBtn').addEventListener('click', askUser);
  if (!userName) setTimeout(askUser, 400);

  let state = null;
  try { state = JSON.parse(localStorage.getItem(LS)); } catch(e) { logErr(e); }
  if (!state) {
    state = SEED.map((o)=>({
      id: slug(o.address), address:o.address, pickup:o.pickup, gas:o.gas,
      out:false,outBy:'',outAt:0, back:false,backBy:'',backAt:0, gasReplace:false,gasBy:'',gasAt:0,
      lat:null,lng:null, pinLat:null,pinLng:null,pinLabel:'', updatedAt:Date.now()
    }));
    saveLocal();
  }
  function saveLocal(){ localStorage.setItem(LS, JSON.stringify(state)); }
  function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function mapURL(a){ return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(a+', Queenstown'); }
  function fmtTime(t){ if(!t) return ''; const d=new Date(t); return d.toLocaleString(); }

  // Filters
  let filterDay = 'All';
  let filterText = '';
  document.getElementById('daySeg').addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    document.querySelectorAll('#daySeg button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    filterDay = b.getAttribute('data-day');
    render();
  });
  document.getElementById('search').addEventListener('input', (e)=>{
    filterText = e.target.value.toLowerCase();
    render();
  });
  function applyFilters(arr){
    return arr.filter(it => {
      const dayPass = (filterDay==='All') || (it.pickup===filterDay);
      const textPass = !filterText || (it.address.toLowerCase().includes(filterText));
      return dayPass && textPass;
    });
  }

  function render(){
    listEl.innerHTML='';
    const items = applyFilters(state);
    items.forEach((it)=>{
      const row = document.createElement('div');
      row.className='addr';

      const outMeta = it.out ? `âœ“ by ${it.outBy||'?'} Â· ${fmtTime(it.outAt)}` : '';
      const backMeta = it.back ? `âœ“ by ${it.backBy||'?'} Â· ${fmtTime(it.backAt)}` : '';
      const gasMeta = it.gasReplace ? `âœ“ by ${it.gasBy||'?'} Â· ${fmtTime(it.gasAt)}` : '';

      const gasCheckbox = it.gas === 'Yes'
        ? `<label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="gasReplace" ${it.gasReplace?'checked':''}> Gas replace?</label>`
        : '';

      row.innerHTML = `
        <div class="topline">
          <div class="name">${it.address}</div>
          <div class="meta">
            <span class="badge">ðŸ—“ ${it.pickup}</span>
            <button class="icon-btn" title="Remove" data-id="${it.id}" data-act="delete">â€“</button>
          </div>
        </div>
        <div class="actions">
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="out" ${it.out?'checked':''}> Out</label>
          <label class="toggle"><input type="checkbox" data-id="${it.id}" data-act="back" ${it.back?'checked':''}> Back</label>
          ${gasCheckbox}
          <a class="maplink" href="${mapURL(it.address)}" target="_blank" rel="noopener">Address map</a>
          <button class="btn" data-id="${it.id}" data-act="setpin">${it.pinLat && it.pinLng ? 'Edit pin' : 'Set pin'}</button>
        </div>
        ${it.pinLat && it.pinLng ? `<div class="mini-map" data-for="${it.id}"></div>` : ''}
        <div class="meta">
          ${outMeta?`<span class="badge">Out: ${outMeta}</span>`:''}
          ${backMeta?`<span class="badge">Back: ${backMeta}</span>`:''}
          ${gasMeta?`<span class="badge warn">Gas: ${gasMeta}</span>`:''}
        </div>
      `;
      listEl.appendChild(row);
    });

    document.querySelectorAll('.mini-map').forEach(el => {
      const id = el.getAttribute('data-for');
      const it = state.find(s => s.id === id);
      if (!it || !it.pinLat || !it.pinLng) return;
      initMiniMap(el, it.pinLat, it.pinLng, it.pinLabel || it.address);
    });
  }

  function initMiniMap(el, lat, lng, label){
    try { if (el._leaflet_map) el._leaflet_map.remove(); } catch(e){}
    const m = L.map(el, { zoomControl:false, attributionControl:false }).setView([lat, lng], 18);
    el._leaflet_map = m;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(m);
    L.marker([lat, lng]).addTo(m).bindPopup(label || '').openPopup();
  }

  // Overlay map for pin
  let bigMap = null, bigMarker = null, activeId = null;
  function openPinOverlay(id){
    const idx = state.findIndex(x=>x.id===id); if (idx<0) return;
    activeId = id;
    overlay.style.display = 'flex';
    overlayTitle.textContent = 'Set Pin â€” ' + state[idx].address;
    pinLabelEl.value = state[idx].pinLabel || '';
    setTimeout(()=>{
      if (bigMap) { try { bigMap.remove(); } catch(e){} bigMap = null; }
      const center = state[idx].pinLat && state[idx].pinLng
        ? [state[idx].pinLat, state[idx].pinLng]
        : (state[idx].lat && state[idx].lng ? [state[idx].lat, state[idx].lng] : [-45.031, 168.662]);
      bigMap = L.map(bigMapEl).setView(center, 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(bigMap);
      bigMarker = L.marker(center, {draggable:true}).addTo(bigMap);
      if (state[idx].pinLat && state[idx].pinLng) bigMarker.setLatLng([state[idx].pinLat, state[idx].pinLng]);
      bigMap.on('click', (e)=>{ if (bigMarker) bigMarker.setLatLng(e.latlng); });
    }, 0);
  }
  function closePinOverlay(){ overlay.style.display = 'none'; activeId = null; }
  document.getElementById('cancelPin').addEventListener('click', closePinOverlay);
  document.getElementById('useGPS').addEventListener('click', async ()=>{
    if (!navigator.geolocation || !bigMarker) return;
    navigator.geolocation.getCurrentPosition((pos)=>{
      bigMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
      bigMap.setView([pos.coords.latitude, pos.coords.longitude], 18);
    });
  });
  document.getElementById('savePin').addEventListener('click', async ()=>{
    if (!activeId || !bigMarker) return closePinOverlay();
    const idx = state.findIndex(x=>x.id===activeId); if (idx<0) return closePinOverlay();
    const ll = bigMarker.getLatLng();
    state[idx].pinLat = ll.lat; state[idx].pinLng = ll.lng;
    state[idx].pinLabel = pinLabelEl.value.trim();
    state[idx].updatedAt = Date.now();
    saveLocal(); render();
    await pushRemote(state[idx]).catch(logErr);
    closePinOverlay();
  });

  listEl.addEventListener('click', (e)=>{
    const b = e.target.closest('button.btn, button.icon-btn'); if(!b) return;
    const id = b.getAttribute('data-id'); const act=b.getAttribute('data-act');
    if (act==='setpin') openPinOverlay(id);
  });

  listEl.addEventListener('change', async (e)=>{
    const cb = e.target.closest('input[type=checkbox]'); if(!cb) return;
    const id = cb.getAttribute('data-id'); const act = cb.getAttribute('data-act');
    const idx = state.findIndex(x=>x.id===id); if (idx<0) return;
    state[idx][act] = cb.checked;
    const now = Date.now();
    if (act==='out'){ state[idx].outBy=userName||''; state[idx].outAt=now; }
    if (act==='back'){ state[idx].backBy=userName||''; state[idx].backAt=now; }
    if (act==='gasReplace'){ state[idx].gasBy=userName||''; state[idx].gasAt=now; }
    state[idx].updatedAt = now; saveLocal(); await pushRemote(state[idx]).catch(logErr); render();
  });

  document.getElementById('addBtn').addEventListener('click', async ()=>{
    const address = prompt('New address (e.g., 15 Birch Street):'); if (!address) return;
    const pickup = prompt('Pickup day (Tue/Wed/Thu/Fri):','Tuesday') || 'Tuesday';
    const gasYN = (prompt('Gas at this address? (Yes/No):','No') || 'No').trim();
    const id = slug(address); if (state.find(x=>x.id===id)) return alert('That address already exists.');
    const now = Date.now();
    const item = { id, address, pickup, gas:(gasYN.toLowerCase()==='yes'?'Yes':'No'),
      out:false,outBy:'',outAt:0, back:false,backBy:'',backAt:0, gasReplace:false,gasBy:'',gasAt:0,
      lat:null,lng:null, pinLat:null,pinLng:null,pinLabel:'', updatedAt:now };
    state.push(item); saveLocal(); render();
    try { const c = await geocodeNominatim(address + ', Queenstown'); if (c){ item.lat=c.lat; item.lng=c.lng; item.updatedAt=Date.now(); saveLocal(); render(); await pushRemote(item).catch(logErr); } } catch(e){}
    await pushRemote(item).catch(logErr);
  });

  document.getElementById('opt').addEventListener('click', async ()=>{
    statusEl.textContent = 'Optimizingâ€¦ getting your location';
    let start = null; try { start = await getCurrentPosition(8000); } catch(e){}
    statusEl.textContent = 'Optimizingâ€¦ geocoding addresses';
    await geocodeAllSequential().catch(logErr);
    const pts = state.map(s=>({...s})).filter(p=>p.lat && p.lng);
    if (pts.length < state.length) { statusEl.textContent='Some addresses not geocoded â€” sorted Aâ†’Z as fallback.'; state.sort((a,b)=>a.address.localeCompare(b.address)); saveLocal(); render(); return; }
    let route = []; let used = new Set(); let currentIdx = 0;
    if (start) { let best=-1, bestd=1e12; for (let i=0;i<pts.length;i++){ const d = dist([start.coords.latitude,start.coords.longitude],[pts[i].lat,pts[i].lng]); if (d<bestd){ bestd=d; best=i; } } currentIdx = best>=0?best:0; }
    for (let k=0;k<pts.length;k++){
      used.add(currentIdx); route.push(pts[currentIdx]);
      let best=-1, bestd=1e12;
      for (let j=0;j<pts.length;j++) if(!used.has(j)){
        const d = dist([pts[currentIdx].lat,pts[currentIdx].lng],[pts[j].lat,pts[j].lng]);
        if (d<bestd){ bestd=d; best=j; }
      }
      if (best===-1) break; currentIdx=best;
    }
    const local = JSON.parse(localStorage.getItem(LS)||'[]');
    state = route.map(r=>{ const l = local.find(x=>x.id===r.id) || r; return {...r, out:l.out, outBy:l.outBy, outAt:l.outAt, back:l.back, backBy:l.backBy, backAt:l.backAt, gasReplace:l.gasReplace, gasBy:l.gasBy, gasAt:l.gasAt, pinLat:l.pinLat, pinLng:l.pinLng, pinLabel:l.pinLabel}; });
    saveLocal(); render(); statusEl.textContent='Optimized by proximity. Tap again anytime.';
  });
  function dist(a,b){ const dx=a[0]-b[0], dy=a[1]-b[1]; return Math.sqrt(dx*dx+dy*dy); }
  function getCurrentPosition(timeout=8000){ return new Promise((res, rej)=>{ if (!navigator.geolocation) return rej(); navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout }); }); }

  async function geocodeAllSequential(){
    for (let i=0;i<state.length;i++){
      if (state[i].lat && state[i].lng) continue;
      const q = state[i].address + ', Queenstown';
      try { const coord = await geocodeNominatim(q); if (coord) { state[i].lat = coord.lat; state[i].lng = coord.lng; saveLocal(); render(); } await sleep(900); } catch(e) { }
    }
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function geocodeNominatim(query){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(query);
    const res = await fetch(url, { headers: { 'Accept':'application/json', 'User-Agent':'BinBackIn/1.0 (contact: hello@example.com)' } });
    if (!res.ok) return null;
    const data = await res.json();
    if (!data || !data.length) return null;
    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
  }

  document.getElementById('refresh').addEventListener('click', async ()=>{ await pullRemote().catch(logErr); });
  document.getElementById('export').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bin-collab-map.json'; a.click(); URL.revokeObjectURL(a.href); });
  document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('file').click());
  document.getElementById('file').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const data=JSON.parse(rd.result); if(Array.isArray(data)){ state=data; saveLocal(); render(); pushAllRemote().catch(logErr); } else alert('Invalid file'); }catch(err){ alert('Could not read file'); } }; rd.readAsText(f); e.target.value=''; });

  // Firestore live sync
  let db = null, unsub = null;
  (async function initFirebase(){
    try { const app=firebase.initializeApp(FIREBASE_CONFIG); db=firebase.firestore(); statusEl.textContent='Sync ON â€” live updates enabled.'; startListener(); pushAllRemote().catch(logErr); }
    catch(e){ statusEl.textContent='Local mode â€” Firebase init failed (check config).'; logErr(e); }
    render();
  })();
  function startListener(){ if(!db) return; if (unsub) unsub(); unsub = db.collection('properties').onSnapshot((snap)=>{ let changed=false; const remote=[]; snap.forEach(doc=>remote.push(doc.data())); for (const r of remote){ const i=state.findIndex(x=>x.id===r.id); if(i>=0){ if(!state[i].updatedAt || r.updatedAt>state[i].updatedAt){ state[i]={...state[i], ...r}; changed=true; } } else { state.push(r); changed=true; } } if(changed){ saveLocal(); render(); } }, (err)=>{ statusEl.textContent='Listener error â€” check Firestore rules.'; logErr(err); }); }
  async function pushRemote(item){ if(!db) return; try{ await db.collection('properties').doc(item.id).set(item, {merge:true}); }catch(e){ logErr(e); throw e; } }
  async function pushAllRemote(){ if(!db) return; for (const it of state) await pushRemote(it); }
  async function pullRemote(){ if(!db) { render(); return; } const snap=await db.collection('properties').get(); snap.forEach(doc=>{ const r=doc.data(); const i=state.findIndex(x=>x.id===r.id); if(i>=0){ if(!state[i].updatedAt || r.updatedAt>state[i].updatedAt) state[i]=r; } else state.push(r); }); saveLocal(); render(); }
</script>
</body>
</html>
